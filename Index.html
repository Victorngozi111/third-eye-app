<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>THIRD EYE - Your All-in-One Companion</title><link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Orbitron:wght@700&display=swap" rel="stylesheet"><!-- Leaflet.js for Interactive Maps --><link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""><script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script><script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" defer="defer"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer="defer"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer="defer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer"><script type="module">import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js"; 
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-analytics.js";
      import { 
        getAuth, 
        createUserWithEmailAndPassword, 
        signInWithEmailAndPassword, 
        signOut, 
        onAuthStateChanged,
        sendPasswordResetEmail,
        RecaptchaVerifier,
        signInWithPhoneNumber
      } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";

      // --- Firebase Configuration ---
      const firebaseConfig = {
        apiKey: "AIzaSyB7y21xCEH_ooZjLJMTLtNEHAmPE5FrEDg",
        authDomain: "third-eye-55ef6.firebaseapp.com",
        projectId: "third-eye-55ef6",
        storageBucket: "third-eye-55ef6.firebasestorage.app",
        messagingSenderId: "55222328361",
        appId: "1:55222328361:web:f4104acbf7c0bdb2305038",
        measurementId: "G-XX9XVQQTB2"
      };

      const app = initializeApp(firebaseConfig);
      try { 
          getAnalytics(app);
      } catch (e) {
          console.log("Firebase Analytics could not be initialized. This is expected in some environments and can be ignored.");
      }
      const auth = getAuth(app);

      // Make Firebase modules globally accessible to the main script
      window.firebaseApp = app; 
      window.firebaseAuth = auth;
      window.firebaseAuthFunctions = {
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        signOut,
        onAuthStateChanged,
        sendPasswordResetEmail,
        RecaptchaVerifier,
        signInWithPhoneNumber
      };</script><script>document.addEventListener('DOMContentLoaded', () => {
            if (typeof pdfjsLib !== 'undefined') {
                 pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js`;
            } else {
                console.error("[TEYE] PDF.js (pdfjsLib) failed to load. PDF functionality will be impaired.");
            }
        });</script><style>:root{--bg-color:#0B0014;--text-color:#E0E6F1;--card-bg-color:#1E0A36;--header-bg-color:#150726;--primary-color-theme:#7E57C2;--primary-hover-theme:#5E35B1;--accent-color-theme:#FFCA28;--secondary-accent-color:#00BFA5;--robot-eye-glow:color-mix(in srgb, var(--accent-color-theme) 70%, transparent);--border-color-theme:#311B4A;--input-bg-color:#100520;--tab-bar-bg:#150726;--tab-icon-color:#A0A0CC;--tab-icon-active-color:var(--accent-color-theme);--shadow-soft:rgba(0, 0, 0, 0.3);--shadow-medium:rgba(40, 0, 80, 0.5);--app-title-font:'Orbitron',sans-serif;--body-font:'Poppins',sans-serif;--focus-outline-color:var(--accent-color-theme);--focus-outline:2px solid var(--focus-outline-color);--focus-outline-offset:2px;--button-icon-spacing:10px;--card-border-radius:16px;--button-border-radius:10px}body.light-theme{--bg-color:#E8EAF6;--text-color:#263238;--card-bg-color:#FFFFFF;--header-bg-color:#3F51B5;--primary-color-theme:#303F9F;--primary-hover-theme:#3949AB;--accent-color-theme:#FF9800;--border-color-theme:#C5CAE9;--tab-bar-bg:#FFFFFF;--tab-icon-color:#546E7A;--shadow-soft:rgba(0, 0, 0, 0.1);--shadow-medium:rgba(0, 0, 0, 0.15)}*,::after,::before{box-sizing:border-box;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}html{scroll-behavior:smooth}body{font-family:var(--body-font);margin:0;background-color:var(--bg-color);color:var(--text-color);padding-bottom:80px;line-height:1.6;transition:background-color .3s,color .3s;font-size:15px}a{color:var(--accent-color-theme);text-decoration:none}a:hover{text-decoration:underline;opacity:.8}button{font-family:var(--body-font)}a:focus-visible,button:focus-visible,img:focus-visible,input:focus-visible,select:focus-visible,textarea:focus-visible{outline:var(--focus-outline);outline-offset:var(--focus-outline-offset);box-shadow:0 0 0 2px var(--bg-color),0 0 0 4px var(--focus-outline-color);border-radius:4px}.app-hidden{display:none!important}#loginOverlay,#permissionsOverlay,#soundPromptOverlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(11,0,20,.97);display:flex;align-items:center;justify-content:center;z-index:10000;transition:opacity .3s ease,visibility 0s linear .3s;padding:15px}.login-card,.permissions-card{background-color:var(--card-bg-color);padding:30px 35px;border-radius:var(--card-border-radius);box-shadow:0 10px 30px var(--shadow-medium);width:100%;max-width:420px;text-align:center;border:1px solid var(--border-color-theme)}.login-card h1,.permissions-card h1{font-family:var(--app-title-font);color:var(--accent-color-theme);margin-bottom:20px;font-size:1.8em;letter-spacing:1px}.login-card .input-group{text-align:left;margin-bottom:18px}.login-card label{display:block;margin-bottom:6px;font-weight:500;font-size:.9em;color:var(--text-color);opacity:.8}.login-card input{width:100%;padding:12px 15px;border-radius:var(--button-border-radius);border:1px solid var(--border-color-theme);background-color:var(--input-bg-color);color:var(--text-color);font-size:1em;transition:border-color .2s}.login-card input:focus{border-color:var(--accent-color-theme)}#grantPermissionsButton,#loginButton,#phoneSignInButton,#registerButton,#sendOtpButton,#verifyOtpButton{width:100%;padding:13px;font-size:1.05em;font-weight:600;background:var(--primary-color-theme);color:#fff;border:none;border-radius:var(--button-border-radius);cursor:pointer;margin-top:10px;transition:background-color .2s,transform .1s;display:flex;align-items:center;justify-content:center;gap:10px}#phoneSignInButton,#registerButton{background-color:var(--accent-color-theme);color:var(--bg-color);margin-top:8px}body.light-theme #phoneSignInButton,body.light-theme #registerButton{color:var(--text-color)}#grantPermissionsButton:hover,#loginButton:hover,#phoneSignInButton:hover,#registerButton:hover,#sendOtpButton:hover,#verifyOtpButton:hover{background:var(--primary-hover-theme);transform:translateY(-1px)}body.light-theme #phoneSignInButton:hover,body.light-theme #registerButton:hover{background:var(--primary-hover-theme)}.login-error-message,.permissions-status{color:#f44336;min-height:1.2em;font-weight:500;margin-top:12px;font-size:.9em}.forgot-password-link{display:block;text-align:right;font-size:.85em;color:var(--accent-color-theme);margin-top:8px;margin-bottom:15px;cursor:pointer}.toggle-auth-mode-link{display:block;text-align:center;font-size:.9em;color:var(--accent-color-theme);margin-top:20px;cursor:pointer}.permissions-card p{margin-bottom:15px;font-size:.95em}.permissions-card ul{list-style:none;padding:0;text-align:left;margin-bottom:20px}.permissions-card li{margin-bottom:8px;padding-left:25px;position:relative;font-size:.9em}.permissions-card li::before{content:"✓";color:var(--accent-color-theme);font-weight:900;display:inline-block;width:1em;margin-left:-1.3em;position:absolute;top:0;left:10px}#skipPermissionsButton{background:0 0;border:1px solid var(--border-color-theme);color:var(--text-color);margin-top:10px;padding:10px;width:100%;border-radius:var(--button-border-radius);cursor:pointer}#skipPermissionsButton:hover{background-color:var(--border-color-theme)}#welcomeMessageOverlay{display:none;position:fixed;top:0;left:0;width:100%;padding:15px;background-color:color-mix(in srgb,var(--primary-color-theme) 90%,#000 10%);color:#fff;text-align:center;z-index:10001;font-size:1.1em;box-shadow:0 2px 10px rgba(0,0,0,.2);animation:fadeInOut 3s ease-in-out forwards}@keyframes fadeInOut{0%{opacity:0;transform:translateY(-20px)}15%{opacity:1;transform:translateY(0)}85%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(-20px);display:none}}#recaptcha-container{margin-top:15px;display:flex;justify-content:center}.app-header{background:var(--header-bg-color);color:#fff;padding:10px 15px;text-align:center;font-family:var(--app-title-font);font-size:1.25em;letter-spacing:1px;box-shadow:0 2px 10px var(--shadow-soft);position:sticky;top:0;z-index:1000;display:flex;align-items:center;justify-content:space-between}.app-header .title-group{display:flex;align-items:center;justify-content:flex-start;flex-grow:1;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}.robot-animation-container{width:40px;height:28px;display:flex;flex-direction:column;align-items:center;justify-content:center;margin-right:10px;flex-shrink:0}.robot-head{width:22px;height:16px;background-color:var(--accent-color-theme);border-radius:8px 8px 4px 4px;position:relative;display:flex;justify-content:center;align-items:center}.robot-eye{width:4px;height:4px;background-color:var(--bg-color);border-radius:50%;margin:0 1.5px;box-shadow:0 0 1.5px .5px var(--robot-eye-glow)}.robot-mouth{width:10px;height:2px;background-color:var(--bg-color);border-radius:1px;position:absolute;bottom:2.5px;left:50%;transform:translateX(-50%)}.app-header .top-right-more-button{background:0 0;border:none;color:#fff;font-size:1.4em;cursor:pointer;padding:8px;flex-shrink:0}.top-right-dropdown-menu{display:none;position:absolute;top:50px;right:5px;background-color:var(--card-bg-color);border:1px solid var(--border-color-theme);border-radius:var(--button-border-radius);box-shadow:var(--shadow-medium);z-index:1001;min-width:230px}.top-right-dropdown-menu.active{display:block}.top-right-dropdown-menu button{display:flex;align-items:center;width:100%;padding:12px 18px;text-align:left;background:0 0;border:none;color:var(--text-color);font-size:.95em;cursor:pointer;border-bottom:1px solid var(--border-color-theme)}.top-right-dropdown-menu button:last-child{border-bottom:none}.top-right-dropdown-menu button:hover{background-color:var(--primary-color-theme);color:#fff}.top-right-dropdown-menu button i{margin-right:12px;color:var(--accent-color-theme);width:18px;text-align:center}.top-right-dropdown-menu button:hover i{color:#fff}.content-area{padding:15px;max-width:900px;margin:0 auto}.tab-content{display:none;animation:contentFadeIn .3s ease-out}.tab-content.active{display:block}@keyframes contentFadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}.page-title{text-align:center;color:var(--accent-color-theme);font-family:var(--app-title-font);margin-bottom:20px;font-size:1.5em;letter-spacing:.5px}.page-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}.page-header .page-title{flex-grow:1;text-align:center;margin:0}.page-header .back-button{background:0 0;border:1px solid var(--border-color-theme);color:var(--text-color);font-size:1em;padding:8px 12px;border-radius:var(--button-border-radius);cursor:pointer;display:flex;align-items:center;gap:8px}.page-header .back-button:hover{background:var(--border-color-theme)}.page-header .placeholder{width:60px}.card{background-color:var(--card-bg-color);color:var(--text-color);padding:20px;border-radius:var(--card-border-radius);box-shadow:0 4px 12px var(--shadow-soft);margin-bottom:20px;border:1px solid var(--border-color-theme)}.card header h1,.card header h2,.card header h3{text-align:center;margin-bottom:5px;color:var(--accent-color-theme)}.card header p{text-align:center;font-size:.9em;opacity:.85;margin-bottom:20px}.card h2,.card h3{margin-top:0;color:var(--accent-color-theme);font-weight:600;font-size:1.2em;margin-bottom:12px}.card p,.card ul{color:var(--text-color);font-size:.9em;line-height:1.65}.card ul{padding-left:20px;margin-top:8px}.card li{margin-bottom:6px}#homeContent .home-welcome-banner{background:linear-gradient(135deg,var(--primary-color-theme),var(--header-bg-color));padding:25px;border-radius:var(--card-border-radius);margin-bottom:25px;text-align:center}#homeWelcomeMessage{color:#fff;font-size:1.6em!important;margin-bottom:5px!important;font-weight:600}#homeTagline{color:#eee;font-size:.95em;opacity:.9}#homeContent .home-section-title{font-size:1.3em;color:var(--accent-color-theme);margin-top:25px;margin-bottom:15px;border-bottom:1px solid var(--border-color-theme);padding-bottom:8px;font-weight:500}.home-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px}.home-feature-card{background-color:var(--card-bg-color);border-radius:var(--card-border-radius);padding:15px;text-align:center;cursor:pointer;transition:all .2s ease-in-out;border:1px solid var(--border-color-theme);display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:110px}.home-feature-card:hover{background-color:var(--primary-hover-theme);transform:scale(1.03);box-shadow:0 6px 15px var(--shadow-medium)}.home-feature-card i{font-size:2em;margin-bottom:8px;display:block;color:var(--accent-color-theme)}.home-feature-card:hover i{color:#fff}.home-feature-card span{font-size:.85em;font-weight:500;color:var(--text-color)}.home-feature-card:hover span{color:#fff}#allFeaturesListContent .feature-list{display:grid;grid-template-columns:1fr;gap:10px;padding:0;list-style:none}#allFeaturesListContent .feature-list li button{display:flex;align-items:center;width:100%;padding:15px 20px;background:var(--card-bg-color);color:var(--text-color);border:1px solid var(--border-color-theme);border-radius:var(--button-border-radius);font-size:1em;font-weight:500;cursor:pointer;transition:all .2s ease-in-out;text-align:left}#allFeaturesListContent .feature-list li button i{margin-right:15px;color:var(--primary-color-theme);width:22px;text-align:center;font-size:1.2em}#allFeaturesListContent .feature-list li button:hover{background:var(--primary-hover-theme);color:#fff;transform:translateX(5px)}#allFeaturesListContent .feature-list li button:hover i{color:#fff}#allFeaturesUserGuidePlayer{margin:0 auto 20px;padding:12px;background-color:var(--card-bg-color);border-radius:var(--card-border-radius);border:1px solid var(--border-color-theme);text-align:center}#allFeaturesUserGuidePlayer p{font-size:.9em;margin-bottom:10px;color:var(--text-color)}#allFeaturesUserGuidePlayer button{background-color:var(--accent-color-theme);color:var(--bg-color);padding:8px 15px;font-size:.9em;border-radius:var(--button-border-radius);border:none;cursor:pointer}body.light-theme #allFeaturesUserGuidePlayer button{color:var(--text-color)}.action-button{background-color:var(--accent-color-theme);color:var(--bg-color);border:none;padding:10px 15px;font-size:1em;border-radius:var(--button-border-radius);cursor:pointer;transition:opacity .2s,background-color .2s;font-weight:500;display:inline-flex;align-items:center;gap:var(--button-icon-spacing)}.action-button:hover{background-color:color-mix(in srgb,var(--accent-color-theme) 80%,#000)}body.light-theme .action-button{color:#1d1c1c}.generic-tool-wrapper .action-button-primary{font-size:1.05em;padding:12px 20px}.file-actions{display:flex;justify-content:center;gap:10px;margin-top:15px;flex-wrap:wrap}.tool-actions-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:15px}.tool-actions-grid .full-width{grid-column:1 / -1}#aroundMeContent .around-me-category-list{list-style:none;padding:0}#aroundMeContent .around-me-category-list li{display:flex;align-items:center;justify-content:space-between;padding:14px 5px;font-size:1em;transition:background-color .2s;border-bottom:1px solid var(--border-color-theme)}#aroundMeContent .around-me-category-list li:last-child{border-bottom:none}#aroundMeContent .around-me-category-list li:hover{background-color:color-mix(in srgb,var(--card-bg-color) 80%,var(--primary-hover-theme) 20%)}#aroundMeContent .around-me-category-list li i{margin-right:12px;color:var(--accent-color-theme);font-size:1.1em}#aroundMeContent .around-me-category-list li input[type=radio]{transform:scale(1.4);accent-color:var(--primary-color-theme);margin-left:auto;cursor:pointer}#moreContent .more-options-list{list-style:none;padding:0}#moreContent .more-options-list li{margin-bottom:10px}#moreContent .more-options-list li i{margin-right:15px;width:22px;text-align:center;color:var(--accent-color-theme);font-size:1.1em}#moreContent .more-options-list li a,#moreContent .more-options-list li button{font-size:1em;padding:16px;border-radius:var(--button-border-radius);width:100%;text-align:left;background-color:var(--header-bg-color);border:1px solid var(--border-color-theme);color:var(--text-color);display:flex;align-items:center;transition:all .2s ease;cursor:pointer}#moreContent .more-options-list li a:hover,#moreContent .more-options-list li button:hover{background-color:var(--primary-hover-theme);color:#fff;transform:translateX(4px)}#logoutButtonDropdown,#moreLogoutButton{color:#ff7043!important}#logoutButtonDropdown i,#moreLogoutButton i{color:#ff7043!important}#logoutButtonDropdown:hover,#moreLogoutButton:hover{background-color:#d32f2f!important;color:#fff!important}#logoutButtonDropdown:hover i,#moreLogoutButton:hover i{color:#fff!important}#reminderModalOverlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(11,0,20,.95);z-index:10002;display:flex;align-items:center;justify-content:center;visibility:hidden;opacity:0;transition:opacity .3s,visibility 0s linear .3s}#reminderModalOverlay.visible{visibility:visible;opacity:1;transition-delay:0s}.reminder-dialog{background:var(--card-bg-color);padding:25px;border-radius:var(--card-border-radius);border:1px solid var(--border-color-theme);box-shadow:var(--shadow-medium);text-align:center;max-width:340px;width:90%}.reminder-dialog h3{color:var(--accent-color-theme);margin-top:0}.reminder-dialog .reminder-options{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:20px 0}.reminder-dialog button{padding:12px;background:var(--primary-color-theme);color:#fff;border:none;border-radius:var(--button-border-radius);cursor:pointer;font-size:.9em}.reminder-dialog button.close-modal{background:var(--header-bg-color);margin-top:10px}.tab-bar{position:fixed;bottom:0;left:0;width:100%;height:65px;background-color:var(--tab-bar-bg);display:flex;justify-content:space-around;align-items:center;box-shadow:0 -2px 10px var(--shadow-soft);z-index:1000;border-top:1px solid var(--border-color-theme)}.tab-button{background:0 0;border:none;color:var(--tab-icon-color);font-family:var(--body-font);cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;flex-grow:1;padding:5px 0;height:100%;transition:color .2s;max-width:25%;font-size:.75em}.tab-button i{font-size:1.6em;margin-bottom:4px}.tab-button.active{color:var(--tab-icon-active-color)}.tab-button .tab-label{font-size:.9em;margin-top:2px}#mapContainer{height:300px;border-radius:var(--card-border-radius);overflow:hidden;background-color:var(--input-bg-color);border:1px solid var(--border-color-theme);z-index:1}.leaflet-container{background:var(--input-bg-color)}#calculatorDisplay{width:100%;background:var(--input-bg-color);border:1px solid var(--border-color-theme);border-radius:var(--button-border-radius);padding:18px;font-size:2.2em;text-align:right;color:var(--text-color);margin-bottom:15px}.calculator-buttons{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}.calculator-buttons button{padding:20px;font-size:1.3em;border-radius:var(--button-border-radius);border:none;cursor:pointer;background:var(--header-bg-color);color:var(--text-color);transition:background-color .2s}.calculator-buttons button.operator{background:var(--primary-color-theme);color:#fff}.calculator-buttons button.clear{background:#d32f2f;color:#fff}.calculator-buttons button:hover{opacity:.8}.results-area{padding:12px;font-size:.95em;background:var(--input-bg-color);border-radius:var(--button-border-radius);margin-top:15px;border:1px solid var(--border-color-theme);color:var(--text-color)}.iam-smart-result-item,.library-item,.news-item,.search-result-item,.transit-result-item{margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid color-mix(in srgb,var(--border-color-theme) 50%,transparent)}.iam-smart-result-item:last-child,.library-item:last-child,.news-item:last-child,.search-result-item:last-child,.transit-result-item:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}.library-item h4,.news-item h3,.search-result-item h4,.transit-result-item h4{margin-top:0;margin-bottom:5px;color:var(--accent-color-theme);font-size:1.05em}.news-item h3 a,.search-result-item a{color:var(--accent-color-theme);text-decoration:none}.news-item h3 a:hover,.search-result-item a:hover{text-decoration:underline}.iam-smart-result-item p,.library-item p,.news-item p,.search-result-item p,.transit-result-item p{margin:2px 0;font-size:.9em}.library-item .library-item-content{white-space:pre-wrap;margin:8px 0}.library-item .library-item-actions{margin-top:8px;display:flex;gap:8px}.library-item .library-item-actions button{font-size:.8em;padding:6px 10px}#codeTesterCodeInput,#htmlToPdfInput,.extracted-text-area{width:100%;min-height:150px;font-family:monospace;font-size:.9em}#codeTesterRenderArea iframe{min-height:250px;width:100%;border:1px solid var(--border-color-theme);background-color:#fff}.file-reader-tool-wrapper .image-preview{max-height:180px;width:auto;display:block;margin:15px auto;border-radius:8px;border:1px solid var(--border-color-theme)}#jokeResultArea,#quotationsContent .results-area{font-family:var(--body-font);white-space:pre-wrap;font-size:1em;text-align:center;min-height:100px;display:flex;flex-direction:column;justify-content:center;align-items:center}#quotationsContent blockquote{font-size:1.15em;font-style:italic;margin-bottom:.5em}#quotationsContent #quoteAuthor{font-size:.95em;opacity:.8;color:var(--text-color)}.generic-tool-wrapper .form-group{margin-bottom:15px}.generic-tool-wrapper .form-group label{display:block;margin-bottom:5px;font-weight:500;font-size:.9em}.generic-tool-wrapper .form-group input:focus,.generic-tool-wrapper .form-group select:focus,.generic-tool-wrapper .form-group textarea:focus,.input-group input:focus,.input-group select:focus{border-color:var(--accent-color-theme);box-shadow:0 0 0 2px color-mix(in srgb,var(--accent-color-theme) 30%,transparent)}.feature-navigation-footer{margin-top:25px;padding-top:15px;border-top:1px solid var(--border-color-theme);display:flex;justify-content:space-between;align-items:center}.feature-navigation-footer button{background-color:var(--primary-color-theme);color:#fff;padding:10px 18px;border:none;border-radius:var(--button-border-radius);font-size:.95em;cursor:pointer;display:inline-flex;align-items:center;gap:var(--button-icon-spacing)}.feature-navigation-footer button:hover{background-color:var(--primary-hover-theme)}.feature-navigation-footer button:disabled{background-color:var(--border-color-theme);cursor:not-allowed;opacity:.7}#floatingAssistantButton{position:fixed;bottom:80px;right:20px;width:60px;height:60px;background-color:var(--primary-color-theme);color:#fff;border:none;border-radius:50%;font-size:1.8em;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 10px var(--shadow-medium);cursor:pointer;z-index:1001;transition:background-color .2s,transform .2s}#floatingAssistantButton:hover{background-color:var(--primary-hover-theme);transform:scale(1.08)}.assistant-listening-indicator{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background-color:rgba(0,0,0,.85);color:#fff;padding:20px;border-radius:10px;font-size:1.2em;z-index:3000;display:none;text-align:center;box-shadow:0 0 12px rgba(0,0,0,.5)}#initialPlayOverlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.9);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;color:#f0f0f0;text-align:center;padding:20px;opacity:0;visibility:hidden;transition:opacity .5s ease,visibility 0s linear .5s}#initialPlayOverlay.visible{opacity:1;visibility:visible;transition:opacity .5s ease}#initialPlayOverlay h2{font-family:var(--app-title-font);font-size:clamp(1.6em,5vw,2.2em);color:var(--accent-color-theme);margin-bottom:18px;text-shadow:1px 1px 2px rgba(0,0,0,.5)}body.light-theme #initialPlayOverlay h2{color:var(--primary-hover-theme)}#initialPlayOverlay p{font-size:clamp(.95em,3.5vw,1.1em);margin-bottom:30px;max-width:550px;line-height:1.6}#initialPlayOverlay button{padding:18px 35px;font-size:clamp(1.2em,4vw,1.6em);font-family:var(--body-font);font-weight:700;background-color:var(--primary-color-theme);color:#fff;border:2px solid var(--primary-hover-theme);border-radius:10px;cursor:pointer;box-shadow:0 5px 18px var(--shadow-medium);transition:background-color .2s,transform .2s,box-shadow .2s;display:flex;align-items:center;gap:10px}#initialPlayOverlay button:focus-visible,#initialPlayOverlay button:hover{background-color:var(--primary-hover-theme);transform:scale(1.05);box-shadow:0 7px 22px var(--shadow-soft)}.qr-code-display img{max-width:100%;height:auto;border:1px solid var(--border-color-theme);border-radius:6px;margin-top:10px}#aiAudioPlayer,#processingSoundAudio,#vocarooInstructionPlayer,#welcomeSoundAudio{position:absolute;left:-9999px;width:1px;height:1px}#codeTesterCodeInput,#htmlToPdfInput,.extracted-text-area,.generic-tool-wrapper .form-group input,.generic-tool-wrapper .form-group select,.generic-tool-wrapper .form-group textarea,.generic-tool-wrapper .input-group input,.tts-tool-wrapper .input-area textarea,.tts-tool-wrapper .voice-selector select{background-color:var(--input-bg-color)!important;color:var(--text-color)!important;border:1px solid var(--border-color-theme)!important;padding:10px 12px!important;border-radius:var(--button-border-radius)!important;width:100%;font-size:1em}#codeTesterCodeInput:focus,#htmlToPdfInput:focus,.extracted-text-area:focus,.generic-tool-wrapper .form-group input:focus,.generic-tool-wrapper .form-group select:focus,.generic-tool-wrapper .form-group textarea:focus,.generic-tool-wrapper .input-group input:focus,.tts-tool-wrapper .input-area textarea:focus,.tts-tool-wrapper .voice-selector select:focus{border-color:var(--accent-color-theme)!important;box-shadow:0 0 0 2px color-mix(in srgb,var(--accent-color-theme) 30%,transparent)!important}.generic-tool-wrapper .form-group select,.news-controls select,.tts-tool-wrapper .voice-selector select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Cpath fill='%23A0A0CC' d='M8 11L2 5h12z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;background-size:12px;-webkit-appearance:none;-moz-appearance:none;appearance:none;padding-right:30px}.action-button-primary{background:var(--primary-color-theme);color:#fff;padding:12px 20px;font-size:1.05em;font-weight:600;border-radius:var(--button-border-radius);border:none;cursor:pointer;transition:background-color .2s,transform .1s;display:flex;align-items:center;justify-content:center;gap:8px;width:100%;max-width:300px;margin:15px auto 0}.action-button-primary:hover{background:var(--primary-hover-theme);transform:translateY(-1px)}.status-message{min-height:1.2em;margin-top:15px;text-align:center;font-weight:500;color:var(--secondary-accent-color)}.file-input-label{display:inline-block;padding:10px 15px;background-color:var(--primary-color-theme);color:#fff;border-radius:var(--button-border-radius);cursor:pointer;text-align:center;margin:10px auto;font-weight:500}.file-input-label:hover{background-color:var(--primary-hover-theme)}input[type=file]{display:none}</style></head><body class="dark-theme"><div id="soundPromptOverlay" style="visibility:hidden;opacity:0;display:none;position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(11,0,20,.97);display:flex;align-items:center;justify-content:center;z-index:10000;transition:opacity .3s ease,visibility 0s linear .3s;padding:15px"><div class="permissions-card"><h1>Enable Audio</h1><p>To hear sounds and voice responses, your interaction is needed to enable audio playback in the browser.</p><p>Please click "Okay" to continue.</p><button id="soundPromptOkButton" class="action-button-primary" style="width:100%;margin-top:15px">Okay</button></div></div><div id="loginOverlay"><div class="login-card"><h1>THIRD EYE</h1><div id="emailAuthContainer"><p style="margin-bottom:25px;font-size:1.05em;color:var(--text-color)">Sign in or create an account to continue.</p><form id="firebaseLoginForm" onsubmit="return!1"><div class="input-group"><label for="emailInput">Email</label><input type="email" id="emailInput" name="email" required autocomplete="email"></div><div class="input-group"><label for="passwordInput">Password (min. 6 characters)</label><input type="password" id="passwordInput" name="password" required autocomplete="current-password"></div><p class="forgot-password-link" id="forgotPasswordLink">Forgot Password?</p><button type="submit" id="loginButton"><i class="fas fa-sign-in-alt"></i>Login</button><button type="button" id="registerButton"><i class="fas fa-user-plus"></i>Create New Account</button></form><a class="toggle-auth-mode-link" id="switchToPhoneAuth">Or Sign In with Phone Number</a></div><div id="phoneAuthContainer" class="app-hidden"><p style="margin-bottom:25px;font-size:1.05em;color:var(--text-color)">Enter your phone number to sign in.</p><div class="input-group"><label for="phoneInput">Phone Number (with country code)</label><input type="tel" id="phoneInput" name="phone" required autocomplete="tel" placeholder="+1234567890"></div><div id="recaptcha-container"></div><button type="button" id="sendOtpButton"><i class="fas fa-paper-plane"></i>Send Verification Code</button><div id="otpContainer" class="app-hidden" style="margin-top:15px"><div class="input-group"><label for="otpInput">Verification Code</label><input type="text" id="otpInput" name="otp" required autocomplete="one-time-code" placeholder="Enter 6-digit code"></div><button type="button" id="verifyOtpButton"><i class="fas fa-check-circle"></i>Verify and Sign In</button></div><a class="toggle-auth-mode-link" id="switchToEmailAuth">Or Sign In with Email</a></div><p id="loginError" class="login-error-message" aria-live="polite"></p></div></div><div id="permissionsOverlay" style="visibility:hidden;opacity:0;display:none"><div class="permissions-card"><h1>Permissions Required</h1><p>To provide the best experience, THIRD EYE needs access to:</p><ul><li><strong>Microphone:</strong>For voice assistant and commands.</li><li><strong>Location:</strong>For "Where Am I?", "Nearby Search", and Location Reminders.</li><li><strong>Camera:</strong>For features like Cash Reader and Scanners.</li></ul><p>You can manage these permissions in your browser settings later.</p><button id="grantPermissionsButton"><i class="fas fa-check-circle"></i>Grant Recommended</button><button id="skipPermissionsButton">Skip for Now</button><p id="permissionsStatus" class="permissions-status" aria-live="polite"></p></div></div><div id="welcomeMessageOverlay"></div><div id="initialPlayOverlay" aria-modal="true" role="dialog" aria-labelledby="initialOverlayTitle" aria-describedby="initialOverlayDescription"><h2 id="initialOverlayTitle">Welcome to THIRD EYE!</h2><p id="initialOverlayDescription">Tap the button below to hear a quick audio guide on how to use the app. This will help you get started smoothly.</p><button id="playInitialInstructionsButton" aria-label="Play audio guide for app instructions"><i class="fas fa-play"></i>Play Audio Guide</button></div><div id="reminderModalOverlay" role="dialog" aria-modal="true" aria-labelledby="reminderDialogTitle"><div class="reminder-dialog"><h3 id="reminderDialogTitle">Set a Location Reminder</h3><p>I will remind you at the selected interval. This will continue until you cancel it from the Location Hub.</p><div class="reminder-options"><button data-interval="5">5 Mins</button><button data-interval="10">10 Mins</button><button data-interval="15">15 Mins</button><button data-interval="20">20 Mins</button><button data-interval="30">30 Mins</button><button data-interval="60">60 Mins</button></div><button class="close-modal" id="closeReminderModalButton" aria-label="Close reminder settings">Cancel Setup</button></div></div><iframe id="vocarooInstructionPlayer" width="1" height="1" src="https://vocaroo.com/embed/1l4oR62TDYEO?autoplay=0" frameborder="0" allow="autoplay" title="App Instructions Audio Player" style="position:absolute;left:-9999px"></iframe><audio id="processingSoundAudio" src="https://media1.vocaroo.com/mp3/1eNaHVuOx2pL" preload="auto" loop></audio><audio id="welcomeSoundAudio" src="data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU2LjQwLjEwMQAAAAAAAAAAAAAA//tAwAAAAAAAAAAAAAAAAAAAAAA//uQZAUAAAAAAAAAAAABAAAJAAAACAAADSAAAA0gAAANJUagAAGUoAAAiQ//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////uQZAUA0gAANIAAAAaQAAAAAAAABJbmZvAAAACgAAABUAAAAYAAABcGFyc191dGlsX2ZpeF92YnJfaGVhZGVyX3dyaXRlAAAAAAAA//uQZAUA0gAANIAAAAaQAAAPUAAAAExhdmMAAAAAnwAAAAQAAAAAAAAAAAAAAAEgAAAAAABVTQAAAAAA//uQZAUTSAAANIAAAAaQAAAPUA//uQRAM0gAAN4gAABpAAAAAAAAA1TEFNRTMuOTkuNVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVUVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV" preload="auto"></audio><audio id="aiAudioPlayer" style="display:none" preload="auto"></audio><header class="app-header app-hidden"><div id="robotAnimation" class="robot-animation-container" aria-hidden="true"><div class="robot-head"><div class="robot-eye"></div><div class="robot-eye"></div><div class="robot-mouth"></div></div></div><div class="title-group">THIRD EYE</div><button class="top-right-more-button" id="topRightMoreButton" aria-label="More app options"><i class="fas fa-ellipsis-v"></i></button><div class="top-right-dropdown-menu" id="topRightDropdownMenu"><button id="dropdownSettingsButton"><i class="fas fa-cog"></i>Settings</button><button id="dropdownLibraryButton"><i class="fas fa-swatchbook"></i>My Library</button><button id="dropdownPrivacyButton"><i class="fas fa-user-secret"></i>Privacy Policy</button><button id="dropdownContactButton"><i class="fas fa-address-book"></i>Contact Details</button><button id="dropdownUserGuideButton"><i class="fas fa-book-open"></i>User Guide</button><button id="themeToggleButtonDropdown"><i class="fas fa-palette"></i>Switch Theme</button><button id="logoutButtonDropdown"><i class="fas fa-sign-out-alt"></i>Logout</button></div></header><main class="content-area app-hidden" id="mainContentArea"><div id="homeContent" class="tab-content active"><div class="home-welcome-banner"><h2 id="homeWelcomeMessage">Welcome to Third Eye!</h2><p id="homeTagline">Your All-in-One Digital Companion.</p></div><div class="card" style="padding-top:10px"><div class="home-section-title">Core Tools</div><div class="home-grid"><button class="home-feature-card" data-target-tab="assistantContent"><i class="fas fa-brain"></i><span>Assistant</span></button><button class="home-feature-card" data-target-tab="textToAudioContent"><i class="fas fa-volume-up"></i><span>Text to Audio</span></button><button class="home-feature-card" data-target-tab="translationContent"><i class="fas fa-language"></i><span>Translator</span></button><button class="home-feature-card" data-target-tab="locationContent"><i class="fas fa-map-marked-alt"></i><span>Location Hub</span></button></div><div class="home-section-title">Vision Tools</div><div class="home-grid"><button class="home-feature-card" data-target-tab="objectIdentifierContent"><i class="fas fa-cube"></i><span>Object ID</span></button><button class="home-feature-card" data-target-tab="documentScannerContent"><i class="fas fa-file-invoice"></i><span>Doc Scanner</span></button><button class="home-feature-card" data-target-tab="cashReaderContent"><i class="fas fa-money-bill-wave"></i><span>Cash Reader</span></button><button class="home-feature-card" data-target-tab="photoReaderContent"><i class="fas fa-image"></i><span>Image to Text</span></button></div><div class="home-section-title">Readers & Converters</div><div class="home-grid"><button class="home-feature-card" data-target-tab="pdfReaderContent"><i class="fas fa-file-pdf"></i><span>PDF Reader</span></button><button class="home-feature-card" data-target-tab="textToPdfContent"><i class="fas fa-file-alt"></i><span>Text to PDF</span></button><button class="home-feature-card" data-target-tab="htmlToPdfToolContent"><i class="fab fa-html5"></i><span>HTML to PDF</span></button><button class="home-feature-card" data-target-tab="textToImageContent"><i class="fas fa-paint-brush"></i><span>Image Gen</span></button></div><div class="home-section-title">Information & Services</div><div class="home-grid"><button class="home-feature-card" data-target-tab="newsContent"><i class="fas fa-newspaper"></i><span>News Updates</span></button><button class="home-feature-card" data-target-tab="transitHubContent"><i class="fas fa-bus-alt"></i><span>Transit Hub</span></button><button class="home-feature-card" data-target-tab="ipInfoToolContent"><i class="fas fa-network-wired"></i><span>IP Info</span></button><button class="home-feature-card" data-target-tab="qrCodeGeneratorToolContent"><i class="fas fa-qrcode"></i><span>QR Generator</span></button></div><div class="home-section-title">Utilities & Creative</div><div class="home-grid"><button class="home-feature-card" data-target-tab="codeTesterToolContent"><i class="fas fa-code"></i><span>Code Tester</span></button><button class="home-feature-card" data-target-tab="calculatorContent"><i class="fas fa-calculator"></i><span>Calculator</span></button><button class="home-feature-card" data-target-tab="slaCalculatorToolContent"><i class="fas fa-tachometer-alt"></i><span>SLA Calculator</span></button><button class="home-feature-card" data-target-tab="jokeContent"><i class="fas fa-laugh-beam"></i><span>Joke Teller</span></button><button class="home-feature-card" data-target-tab="quotationsContent"><i class="fas fa-quote-left"></i><span>Quotations</span></button></div></div></div><div id="allFeaturesListContent" class="tab-content"><div class="page-header"><div class="placeholder"></div><h1 class="page-title">All Features</h1><div class="placeholder"></div></div><div id="allFeaturesUserGuidePlayer"><p>Tap to hear how to use the app:</p><button id="playAppGuideAllFeatures"><i class="fas fa-play"></i>Play App Guide</button></div><ul class="feature-list card"><li><button data-target-tab="assistantContent"><i class="fas fa-brain"></i>Assistant</button></li><li><button data-target-tab="objectIdentifierContent"><i class="fas fa-cube"></i>Object Identifier</button></li><li><button data-target-tab="documentScannerContent"><i class="fas fa-file-invoice"></i>Document Scanner</button></li><li><button data-target-tab="cashReaderContent"><i class="fas fa-money-bill-wave"></i>Cash Reader</button></li><li><button data-target-tab="locationContent"><i class="fas fa-map-marked-alt"></i>Location Hub (Map, Nav, Transit)</button></li><li><button data-target-tab="photoReaderContent"><i class="fas fa-image"></i>Image to Text Reader (AI)</button></li><li><button data-target-tab="pdfReaderContent"><i class="fas fa-file-pdf"></i>PDF Reader</button></li><li><button data-target-tab="textToAudioContent"><i class="fas fa-volume-up"></i>Text to Audio (AI Voice)</button></li><li><button data-target-tab="textToImageContent"><i class="fas fa-paint-brush"></i>Image Generator</button></li><li><button data-target-tab="newsContent"><i class="fas fa-newspaper"></i>News Updates</button></li><li><button data-target-tab="translationContent"><i class="fas fa-language"></i>Translator</button></li><li><button data-target-tab="calculatorContent"><i class="fas fa-calculator"></i>Calculator</button></li><li><button data-target-tab="quotationsContent"><i class="fas fa-quote-left"></i>Quotations</button></li><li><button data-target-tab="jokeContent"><i class="fas fa-laugh-beam"></i>Joke Teller</button></li><li><button data-target-tab="textToPdfContent"><i class="fas fa-file-alt"></i>Text-to-PDF Generator</button></li><li><button data-target-tab="htmlToPdfToolContent"><i class="fab fa-html5"></i>HTML-to-PDF Converter</button></li><li><button data-target-tab="codeTesterToolContent"><i class="fas fa-code"></i>Code Tester (HTML)</button></li><li><button data-target-tab="qrCodeGeneratorToolContent"><i class="fas fa-qrcode"></i>QR Code Generator</button></li><li><button data-target-tab="slaCalculatorToolContent"><i class="fas fa-tachometer-alt"></i>SLA Calculator</button></li><li><button data-target-tab="ipInfoToolContent"><i class="fas fa-network-wired"></i>IP Info Tool</button></ul></div><div id="navigationContent" class="tab-content"><div class="page-header"><button class="back-button" data-target-tab="allFeaturesListContent"><i class="fas fa-arrow-left"></i>Back</button><h1 class="page-title">Navigation</h1><div class="placeholder"></div></div><div class="card nav-mode-selection"><header><h2>Choose Navigation Mode</h2><p>Select how you'd like to navigate or find places.</p></header><div class="home-grid" style="grid-template-columns:1fr 1fr;gap:15px"><button class="home-feature-card" id="aroundMeNavButton" data-target-tab="aroundMeContent"><i class="fas fa-street-view"></i><span>Around Me</span></button><button class="home-feature-card" id="travelModeNavButton" data-target-tab="travelModeContent"><i class="fas fa-route"></i><span>Travel Mode</span></button></div></div></div><div id="aroundMeContent" class="tab-content"><div class="page-header"><button class="back-button" data-target-tab="locationContent"><i class="fas fa-arrow-left"></i>Back</button><h1 class="page-title">Around Me</h1><div class="placeholder"></div></div><div class="card"><header><h2>Find Places Nearby</h2><p>Select a category to find places near your current location. Ensure you've used "Where Am I?" in the Location Hub first.</p></header><ul class="around-me-category-list"><li><span><i class="fas fa-credit-card"></i>ATM</span><input type="radio" name="aroundMeCategory" value="atm" checked="checked"></li><li><span><i class="fas fa-bus"></i>Bus Stations</span><input type="radio" name="aroundMeCategory" value="bus_station"></li><li><span><i class="fas fa-university"></i>Bank</span><input type="radio" name="aroundMeCategory" value="bank"></li><li><span><i class="fas fa-film"></i>Cinema</span><input type="radio" name="aroundMeCategory" value="cinema"></li><li><span><i class="fas fa-utensils"></i>Food / Restaurant</span><input type="radio" name="aroundMeCategory" value="catering"></li><li><span><i class="fas fa-hospital"></i>Hospital</span><input type="radio" name="aroundMeCategory" value="hospital"></li><li><span><i class="fas fa-hotel"></i>Hotels</span><input type="radio" name="aroundMeCategory" value="accommodation"></li><li><span><i class="fas fa-gas-pump"></i>Petrol Stations</span><input type="radio" name="aroundMeCategory" value="fuel"></li><li><span><i class="fas fa-restroom"></i>Public Toilets</span><input type="radio" name="aroundMeCategory" value="toilet"></li><li><span><i class="fas fa-place-of-worship"></i>Religious Places</span><input type="radio" name="aroundMeCategory" value="place_of_worship"></li></ul><button id="aroundMeFindButton" class="action-button-primary"><i class="fas fa-search-location"></i>Find Selected Near Me!</button><p class="status-message" id="aroundMeStatus" aria-live="polite"></p><div id="aroundMeResultsArea" class="results-area"></div></div></div><div id="travelModeContent" class="tab-content"><div class="page-header"><button class="back-button" data-target-tab="locationContent"><i class="fas fa-arrow-left"></i>Back</button><h1 class="page-title">Travel Mode</h1><div class="placeholder"></div></div><div class="card"><header><h2>Travel Mode (Route Planning)</h2><p>This feature for route planning and live navigation is a high-priority future goal.</p></header><p style="text-align:center;margin-top:20px"><i class="fas fa-traffic-light" style="font-size:3em;color:var(--accent-color-theme)"></i></p><p style="text-align:center;font-style:italic">Complex turn-by-turn navigation is in active development planning. Stay tuned!</p></div></div><div id="calculatorContent" class="tab-content"><div class="page-header"><button class="back-button" data-target-tab="allFeaturesListContent"><i class="fas fa-arrow-left"></i>Back</button><h1 class="page-title">Calculator</h1><div class="placeholder"></div></div><div class="card generic-tool-wrapper"><input type="text" id="calculatorDisplay" readonly="readonly" placeholder="0"><div class="calculator-buttons"><button class="clear" data-value="AC">AC</button><button data-value="DEL">DEL</button><button class="operator" data-value="%">%</button><button class="operator" data-value="/">÷</button><button data-value="7">7</button><button data-value="8">8</button><button data-value="9">9</button><button class="operator" data-value="*">×</button><button data-value="4">4</button><button data-value="5">5</button><button data-value="6">6</button><button class="operator" data-value="-">-</button><button data-value="1">1</button><button data-value="2">2</button><button data-value="3">3</button><button class="operator" data-value="+">+</button><button data-value="00">00</button><button data-value="0">0</button><button data-value=".">.</button><button class="operator" data-value="=">=</button></div></div></div><div id="quotationsContent" class="tab-content"><div class="page-header"><button class="back-button" data-target-tab="allFeaturesListContent"><i class="fas fa-arrow-left"></i>Back</button><h1 class="page-title">Daily Quotations</h1><div class="placeholder"></div></div><div class="card generic-tool-wrapper"><header><h1>Words of Wisdom</h1><p>Get inspired with a random quote, or specify a theme.</p></header><div class="form-group"><label for="quoteCategoryInput">Quote Theme (optional):</label><input type="text" id="quoteCategoryInput" placeholder="e.g., success, motivational, funny"></div><button id="fetchQuoteButton" class="action-button-primary" style="max-width:250px"><i class="fas fa-sync-alt"></i>Get New Quote</button><p class="status-message" id="quoteStatus" aria-live="polite"></p><div id="quoteResultArea" class="results-area" style="text-align:center;min-height:120px"><blockquote id="quoteText" style="margin:0;padding:0"></blockquote><p id="quoteAuthor" style="font-style:italic;margin-top:10px"></p></div><div class="file-actions"><button id="readQuoteButton" class="action-button" disabled="disabled"><i class="fas fa-volume-up"></i>Read</button><button id="copyQuoteButton" class="action-button" disabled="disabled"><i class="fas fa-copy"></i>Copy</button><button id="shareQuoteButton" class="action-button" disabled="disabled"><i class="fas fa-share-alt"></i>Share</button><button id="libraryAddQuoteButton" class="action-button" disabled="disabled"><i class="fas fa-plus"></i>Add to Library</button></div></div></div><div id="assistantContent" class="tab-content"><div class="page-header"><button class="back-button" data-target-tab="allFeaturesListContent"><i class="fas fa-arrow-left"></i>Back</button><h1 class="page-title">AI Assistant</h1><div class="placeholder"></div></div><div class="card generic-tool-wrapper"><header><h2>Ask me Anything</h2><p>Tap the floating robot button or double-tap anywhere to activate voice commands. You can also type commands below.</p></header><div class="form-group"><label for="assistantCommandInput">Type your command or question:</label><textarea id="assistantCommandInput" placeholder="e.g., 'What's the weather like?' or 'Go to news'" rows="3"></textarea></div><button id="submitAssistantCommand" class="action-button-primary"><i class="fas fa-paper-plane"></i>Send Command</button><p class="status-message" id="assistantStatusMessage" aria-live="polite"></p><div id="assistantResponseOutput" class="results-area" style="min-height:100px">Assistant responses will appear here.</div></div></div><div id="textToAudioContent" class="tab-content"><div class="page-header"><button class="back-button" data-target-tab="allFeaturesListContent"><i class="fas fa-arrow-left"></i>Back</button><h1 class="page-title">Text-to-Audio (AI Voice)</h1></div><div class="tts-tool-wrapper card"><header><h1>Amplify Your Text</h1><p>I can read any text aloud using a high-quality voice. Type or paste it below, then you can listen or download the audio.</p></header><main><div class="input-area"><label for="textToSpeak" class="sr-only">Text to be spoken</label><textarea id="textToSpeak" placeholder="Enter text here..." aria-label="Text to be spoken"></textarea></div><div class="controls" style="margin-top:15px"><div class="voice-selector form-group"><label for="aiVoiceSelect">Choose Voice:</label><select id="aiVoiceSelect"><option value="alloy">Alloy (Female)</option><option value="echo">Echo (Male)</option><option value="fable" selected="selected">Fable (Female, Storyteller)</option><option value="onyx">Onyx (Male, Deep)</option><option value="nova">Nova (Female, Upbeat)</option><option value="shimmer">Shimmer (Female)</option></select></div></div><div class="tool-actions-grid"><button id="speakButton" class="action-button"><i class="fas fa-play-circle"></i>Read Aloud</button><button id="ttsDownloadAudioButton" class="action-button"><i class="fas fa-download"></i>Download Audio</button><button id="ttsCopyTextButton" class="action-button"><i class="fas fa-copy"></i>Copy Text</button><button id="ttsShareTextButton" class="action-button"><i class="fas fa-share-alt"></i>Share Text</button><button id="stopButton" class="action-button full-width"><i class="fas fa-stop-circle"></i>Stop Speech</button></div><p class="status-message" id="ttsStatusMessage" aria-live="polite"></p></main></div></div><div id="translationContent" class="tab-content"><div class="page-header"><button class="back-button" data-target-tab="allFeaturesListContent"><i class="fas fa-arrow-left"></i>Back</button><h1 class="page-title">Language Translator</h1><div class="placeholder"></div></div><div class="card generic-tool-wrapper"><header><h1>Translate Text</h1><p>Translate text between various languages.</p></header><div class="translation-controls" style="display:flex;align-items:center;gap:10px;margin-bottom:15px"><select id="translateFromLang" aria-label="Translate from language" style="flex-grow:1"></select><button id="swapLanguagesButton" aria-label="Swap languages" title="Swap Languages" class="action-button" style="padding:8px 12px;font-size:1.2em">&#x21C4;</button><select id="translateToLang" aria-label="Translate to language" style="flex-grow:1"></select></div><textarea id="translationInput" placeholder="Enter text to translate..." aria-label="Text to translate" rows="4" style="margin-bottom:10px"></textarea><button id="translateButton" class="action-button-primary"><i class="fas fa-language"></i>Translate</button><p class="status-message" id="translationStatus" aria-live="polite"></p><textarea id="translationOutput" placeholder="Translation will appear here..." aria-label="Translated text" readonly="readonly" rows="4" style="margin-top:10px"></textarea><div class="file-actions"><button id="readTranslatedTextButton" class="action-button" disabled="disabled"><i class="fas fa-volume-up"></i>Read Translation</button><button id="copyTranslatedTextButton" class="action-button" disabled="disabled"><i class="fas fa-copy"></i>Copy Translation</button></div></div></div><div id="photoReaderContent" class="tab-content"><div class="page-header"><button class="back-button" data-target-tab="allFeaturesListContent"><i class="fas fa-arrow-left"></i>Back</button><h1 class="page-title">Image to Text Reader (AI)</h1><div class="placeholder"></div></div><div class="file-reader-tool-wrapper card"><header><h1>Extract Text from Images</h1><p>Use your camera or select a photo to extract text with advanced AI.</p></header><div class="home-grid" style="grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px"><button id="startCameraButtonPhoto" class="home-feature-card" style="min-height:80px"><i class="fas fa-camera"></i><span>Use Camera</span></button><label for="photoFile" class="home-feature-card" style="min-height:80px"><i class="fas fa-upload"></i><span>From Photos</span></label><input type="file" id="photoFile" accept="image/png, image/jpeg, image/bmp, image/webp"></div><div id="photoCameraContainer" class="camera-container" style="display:none"><video id="photoCameraFeed" playsinline autoplay muted style="width:100%;height:auto;display:block"></video><button id="capturePhotoButton" class="action-button-primary camera-capture-button"><i class="fas fa-camera-retro"></i>Capture</button></div><canvas id="photoCanvas" style="display:none"></canvas><img id="photoPreview" src="#" alt="Selected image preview" class="image-preview" style="display:none"><p class="status-message" id="photoReaderStatus" aria-live="polite"></p><label for="photoExtractedText" class="sr-only">Extracted text from photo</label><textarea id="photoExtractedText" class="extracted-text-area" placeholder="Extracted text will appear here..." aria-label="Extracted text from photo" rows="6"></textarea><div class="tool-actions-grid"><button id="readPhotoTextButton" class="action-button" disabled><i class="fas fa-volume-up"></i>Read Aloud</button><button id="copyPhotoTextButton" class="action-button" disabled><i class="fas fa-copy"></i>Copy Text</button><button id="sharePhotoTextButton" class="action-button" disabled><i class="fas fa-share-alt"></i>Share Text</button><button id="stopPhotoTextButton" class="action-button" disabled><i class="fas fa-stop-circle"></i>Stop Speech</button></div></div></div><div id="pdfReaderContent" class="tab-content"><div class="page-header"><button class="back-button" data-target-tab="allFeaturesListContent"><i class="fas fa-arrow-left"></i>Back</button><h1 class="page-title">PDF Reader</h1><div class="placeholder"></div></div><div class="file-reader-tool-wrapper card"><header><h1>PDF Tools</h1><p>Extract text from a PDF, then read, analyze, or download it.</p></header><label for="pdfFile" class="file-input-label"><i class="fas fa-file-pdf"></i>Choose PDF</label><input type="file" id="pdfFile" accept="application/pdf"><p class="status-message" id="pdfReaderStatus" aria-live="polite"></p><div class="pdf-navigation" style="display:none;text-align:center;margin:15px 0"><button id="pdfPrevPageButton" class="action-button" disabled><i class="fas fa-arrow-left"></i>Prev</button><span id="pdfPageIndicator" class="pdf-page-indicator" style="margin:0 15px;font-weight:700">Page 0 of 0</span><button id="pdfNextPageButton" class="action-button" disabled>Next<i class="fas fa-arrow-right"></i></button></div><label for="pdfExtractedText" class="sr-only">Extracted text from PDF</label><textarea id="pdfExtractedText" class="extracted-text-area" placeholder="Extracted text will appear here..." aria-label="Extracted text from PDF" readonly rows="7"></textarea><div class="tool-actions-grid" style="margin-top:20px"><button id="readPdfPageButton" class="action-button" disabled><i class="fas fa-volume-up"></i>Read Page</button><button id="pdfAnalyzePageButton" class="action-button" disabled><i class="fas fa-brain"></i>Analyze Page</button><button id="pdfDownloadAllTextButton" class="action-button" disabled><i class="fas fa-file-alt"></i>Download All Text</button><button id="pdfDownloadAllAudioButton" class="action-button" disabled><i class="fas fa-download"></i>Download Audio</button><button id="pdfShareAllTextButton" class="action-button" disabled><i class="fas fa-share-alt"></i>Share All Text</button><button id="pdfCopyPageButton" class="action-button" disabled><i class="fas fa-copy"></i>Copy Page</button></div></div></div><div id="textToImageContent" class="tab-content"><div class="page-header"><button class="back-button" data-target-tab="allFeaturesListContent"><i class="fas fa-arrow-left"></i>Back</button><h1 class="page-title">Image Generator</h1><div class="placeholder"></div></div><div class="card"><header><h1>Create with Words</h1><p>Describe the image you want me to create. Be as descriptive as possible!</p></header><div class="form-group"><label for="imagePrompt" class="sr-only">Prompt for image generation</label><textarea id="imagePrompt" class="extracted-text-area" placeholder="e.g., a cute cat wearing a wizard hat, digital art" aria-label="Prompt for image generation" rows="3"></textarea></div><button id="generateImageButton" class="action-button-primary"><i class="fas fa-magic"></i>Generate Image</button><p class="status-message" id="imageGeneratorStatus" aria-live="polite"></p><div id="imageResultContainer" style="margin-top:20px;text-align:center"><img id="generatedImage" src="#" alt="Generated image will appear here" style="max-width:100%;border-radius:var(--card-border-radius);display:none;margin-top:10px;border:1px solid var(--border-color-theme)"></div><div class="file-actions" id="imageActionButtons" style="display:none"><button id="regenerateImageButton" class="action-button"><i class="fas fa-redo"></i>Regenerate</button><button id="downloadImageButton" class="action-button"><i class="fas fa-download"></i>Download</button><button id="libraryAddImageButton" class="action-button"><i class="fas fa-plus"></i>Add to Library</button></div></div></div><div id="cashReaderContent" class="tab-content"><div class="page-header"><button class="back-button" data-target-tab="allFeaturesListContent"><i class="fas fa-arrow-left"></i>Back</button><h1 class="page-title">Cash Reader</h1><div class="placeholder"></div></div><div class="file-reader-tool-wrapper card generic-tool-wrapper"><header><h1>Identify Currency with Vision</h1><p>Use your camera or select a photo to identify a currency note. Best for clear, single notes.</p></header><div class="home-grid" style="grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px"><button id="startCameraButtonCash" class="home-feature-card" style="min-height:80px"><i class="fas fa-camera"></i><span>Use Camera</span></button><label for="cashFile" class="home-feature-card" style="min-height:80px"><i class="fas fa-upload"></i><span>From Photos</span></label><input type="file" id="cashFile" accept="image/png, image/jpeg, image/webp"></div><div id="cashCameraContainer" class="camera-container" style="display:none"><video id="cashCameraFeed" playsinline autoplay muted style="width:100%;height:auto;display:block"></video><button id="captureCashButton" class="action-button-primary camera-capture-button"><i class="fas fa-camera-retro"></i>Capture</button></div><canvas id="cashCanvas" style="display:none"></canvas><img id="cashPreview" src="#" alt="Selected currency image preview" class="image-preview" style="display:none"><p class="status-message" id="cashReaderStatus" aria-live="polite"></p><div id="cashResultArea" class="results-area" style="font-weight:700;font-size:1.1em;text-align:center"></div><div class="file-actions"><button id="readCashResultButton" class="action-button" disabled="disabled"><i class="fas fa-volume-up"></i>Read Result</button></div><p style="font-size:.8em;opacity:.7;margin-top:15px;text-align:center"><strong>Disclaimer:</strong>This is an experimental feature. Identification can make mistakes. It is for informational purposes only and should<strong>NOT</strong>be used for financial transactions. Always verify currency manually.</p></div></div><div id="objectIdentifierContent" class="tab-content"><div class="page-header"><button class="back-button" data-target-tab="allFeaturesListContent"><i class="fas fa-arrow-left"></i>Back</button><h1 class="page-title">Object Identifier</h1><div class="placeholder"></div></div><div class="file-reader-tool-wrapper card generic-tool-wrapper"><header><h1>What is This?</h1><p>Use your camera or select a photo to identify an object in front of you.</p></header><div class="home-grid" style="grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px"><button id="startCameraButtonObject" class="home-feature-card" style="min-height:80px"><i class="fas fa-camera"></i><span>Use Camera</span></button><label for="objectFile" class="home-feature-card" style="min-height:80px"><i class="fas fa-upload"></i><span>From Photos</span></label><input type="file" id="objectFile" accept="image/png, image/jpeg, image/webp"></div><div id="objectCameraContainer" class="camera-container" style="display:none"><video id="objectCameraFeed" playsinline autoplay muted style="width:100%;height:auto;display:block"></video><button id="captureObjectButton" class="action-button-primary camera-capture-button"><i class="fas fa-camera-retro"></i>Capture</button></div><canvas id="objectCanvas" style="display:none"></canvas><img id="objectPreview" src="#" alt="Selected object image preview" class="image-preview" style="display:none"><p class="status-message" id="objectIdentifierStatus" aria-live="polite"></p><div id="objectResultArea" class="results-area" style="font-weight:700;font-size:1.1em;text-align:center"></div><div class="file-actions"><button id="readObjectResultButton" class="action-button" disabled="disabled"><i class="fas fa-volume-up"></i>Read Result</button></div></div></div><div id="documentScannerContent" class="tab-content"><div class="page-header"><button class="back-button" data-target-tab="allFeaturesListContent"><i class="fas fa-arrow-left"></i>Back</button><h1 class="page-title">Document Scanner</h1><div class="placeholder"></div></div><div class="file-reader-tool-wrapper card generic-tool-wrapper"><header><h1>Scan Documents</h1><p>Use your camera or a photo to scan a document and extract key information.</p></header><div class="home-grid" style="grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px"><button id="startCameraButtonDoc" class="home-feature-card" style="min-height:80px"><i class="fas fa-camera"></i><span>Use Camera</span></button><label for="docFile" class="home-feature-card" style="min-height:80px"><i class="fas fa-upload"></i><span>From Photos</span></label><input type="file" id="docFile" accept="image/png, image/jpeg, image/webp"></div><div id="docCameraContainer" class="camera-container" style="display:none"><video id="docCameraFeed" playsinline autoplay muted style="width:100%;height:auto;display:block"></video><button id="captureDocButton" class="action-button-primary camera-capture-button"><i class="fas fa-camera-retro"></i>Capture</button></div><canvas id="docCanvas" style="display:none"></canvas><img id="docPreview" src="#" alt="Selected document image preview" class="image-preview" style="display:none"><p class="status-message" id="docScannerStatus" aria-live="polite"></p><div id="docResultArea" class="results-area" style="font-size:1em;text-align:left;white-space:pre-wrap"></div><div class="file-actions"><button id="readDocResultButton" class="action-button" disabled="disabled"><i class="fas fa-volume-up"></i>Read Result</button><button id="copyDocResultButton" class="action-button" disabled="disabled"><i class="fas fa-copy"></i>Copy Result</button></div></div></div><div id="locationContent" class="tab-content"><div class="page-header"><button class="back-button" data-target-tab="allFeaturesListContent"><i class="fas fa-arrow-left"></i>Back</button><h1 class="page-title">Location Hub</h1><div class="placeholder"></div></div><div class="card generic-tool-wrapper"><header><h2>Location Tools & Interactive Map</h2><p>Find your position, search nearby places, get transit info, or set reminders.</p></header><div id="mapContainer"></div><div class="home-grid" style="grid-template-columns:1fr 1fr;gap:10px;margin:20px 0 10px"><button id="getLocationButton" class="home-feature-card" style="min-height:80px"><i class="fas fa-map-marker-alt"></i><span>Where Am I?</span></button><button id="setReminderButton" class="home-feature-card" style="min-height:80px"><i class="fas fa-stopwatch"></i><span>Set Reminder</span></button><button data-target-tab="aroundMeContent" class="home-feature-card" style="min-height:80px"><i class="fas fa-street-view"></i><span>Around Me</span></button><button data-target-tab="transitHubContent" class="home-feature-card" style="min-height:80px"><i class="fas fa-bus-alt"></i><span>Transit Hub</span></button></div><div id="userLocationSection" style="margin-top:10px"><p class="status-message" id="locationStatus" aria-live="polite"></p><div id="activeReminderStatus" style="text-align:center;font-weight:700;color:var(--secondary-accent-color);margin-bottom:10px"></div><div id="locationResultCard" class="results-area" style="display:none"><p><strong>Address:</strong><span id="locationAddress">Not available</span></p><p><strong>Coordinates:</strong><span id="locationCoords">Not available</span></p><button id="locationTellMeMoreButton" class="action-button" style="margin-top:10px;display:none"><i class="fas fa-info-circle"></i>Tell Me More About This Area</button></div><div class="file-actions"><button id="readLocationButton" class="action-button" disabled="disabled"><i class="fas fa-volume-up"></i>Read My Location</button></div></div><div class="hub-section" style="margin-top:20px"><h3 style="text-align:center">Quick Search (Global)</h3><p style="font-size:.85em;opacity:.8;text-align:center">(Use "Around Me" for local results)</p><div id="nearbySearchContainer" class="form-group" style="display:flex;gap:10px;margin-top:10px"><label for="nearbySearchInput" class="sr-only">Search for any location</label><input type="text" id="nearbySearchInput" placeholder="e.g., Eiffel Tower, Tokyo" style="flex-grow:1"><button id="executeSearchButton" class="action-button" style="padding:10px 15px"><i class="fas fa-search"></i></button></div><p class="status-message" id="nearbyStatusMessage" aria-live="polite"></p><div id="nearbySearchResults" class="results-area" aria-live="polite"></div></div></div></div><div id="transitHubContent" class="tab-content"><div class="page-header"><button class="back-button" data-target-tab="locationContent"><i class="fas fa-arrow-left"></i>Back</button><h1 class="page-title">Transit Hub</h1><div class="placeholder"></div></div><div class="card generic-tool-wrapper"><header><h1>Real-time Transit & Service Info</h1><p>Get live updates for buses, trains, and local services.</p></header><div class="sub-feature-card card" style="background-color:var(--input-bg-color)"><h3>Real Time Bus Data (KMB/LWB, HK)</h3><div class="form-group"><label for="busCompany">Company:</label><select id="busCompany"><option value="kmb">KMB</option><option value="lwb">LWB</option></select></div><div class="form-group"><label for="busRoute">Route:</label><input type="text" id="busRoute" placeholder="e.g., 1A"></div><div class="form-group"><label for="busStopId">Stop ID (Optional):</label><input type="text" id="busStopId" placeholder="e.g., AFA8F8A154F73307"></div><button id="fetchBusDataButton" class="action-button-primary">Get Bus ETA</button><p class="status-message" id="busDataStatus" aria-live="polite"></p><div id="busDataResultArea" class="results-area"></div></div><div class="sub-feature-card card" style="background-color:var(--input-bg-color);margin-top:20px"><h3>Konkan Railway Live Position (India)</h3><div class="form-group"><label for="konkanTrainNo">Train Number:</label><input type="text" id="konkanTrainNo" placeholder="e.g., 10103"></div><button id="fetchKonkanTrainButton" class="action-button-primary">Get Train Position</button><p class="status-message" id="konkanTrainStatus" aria-live="polite"></p><div id="konkanTrainResultArea" class="results-area"></div></div><div class="sub-feature-card card" style="background-color:var(--input-bg-color);margin-top:20px"><h3>Swiss Federal Railways (SBB) - Current Departures</h3><div class="form-group"><label for="sbbStation">Station Name:</label><input type="text" id="sbbStation" placeholder="e.g., Zürich HB, Bern, Genève"></div><button id="fetchSbbDataButton" class="action-button-primary">Get SBB Departures</button><p class="status-message" id="sbbDataStatus" aria-live="polite"></p><div id="sbbDataResultArea" class="results-area"></div><p style="font-size:.8em;opacity:.7;margin-top:10px;text-align:center">Note: Provides current departure data, not previous day's full records.</p></div><div class="sub-feature-card card" style="background-color:var(--input-bg-color);margin-top:20px"><h3>iAM Smart Registration Locations (HK)</h3><button id="fetchIamSmartButton" class="action-button-primary">Get Locations</button><p class="status-message" id="iamSmartStatus" aria-live="polite"></p><div id="iamSmartResultArea" class="results-area"></div></div></div></div><div id="newsContent" class="tab-content"><div class="page-header"><button class="back-button" data-target-tab="allFeaturesListContent"><i class="fas fa-arrow-left"></i>Back</button><h1 class="page-title">News Updates</h1><div class="placeholder"></div></div><div class="card generic-tool-wrapper"><header><h1>Latest Headlines</h1><p>Get top news stories by category from around the world.</p></header><div class="news-controls form-group" style="display:flex;flex-wrap:wrap;gap:15px;align-items:flex-end"><div style="flex-grow:1"><label for="newsCategorySelect">Category:</label><select id="newsCategorySelect"><option value="top">Top Headlines</option><option value="technology">Technology</option><option value="business">Business</option><option value="sports">Sports</option><option value="health">Health</option><option value="science">Science</option><option value="entertainment">Entertainment</option></select></div><div style="flex-grow:1"><label for="newsCountrySelect">Country:</label><select id="newsCountrySelect"></select></div></div><button id="getNewsButton" class="action-button-primary"><i class="fas fa-newspaper"></i>Fetch Latest News</button><p class="status-message" id="newsStatus" aria-live="polite"></p><div id="newsResultArea" class="results-area"></div><div class="file-actions"><button id="readNewsButton" class="action-button" disabled="disabled"><i class="fas fa-volume-up"></i>Read Headlines</button></div></div></div><div id="textToPdfContent" class="tab-content"><div class="page-header"><button class="back-button" data-target-tab="allFeaturesListContent"><i class="fas fa-arrow-left"></i>Back</button><h1 class="page-title">Text-to-PDF Generator</h1><div class="placeholder"></div></div><div class="card generic-tool-wrapper"><header><h1>Create PDF from Text</h1><p>Enter your text below and convert it into a PDF document.</p></header><div class="form-group"><label for="textForPdf" class="sr-only">Text for PDF conversion</label><textarea id="textForPdf" placeholder="Enter text to convert to PDF..." aria-label="Text for PDF conversion" style="min-height:200px" rows="10"></textarea></div><button id="generatePdfButton" class="action-button-primary"><i class="fas fa-file-pdf"></i>Generate PDF</button><p class="status-message" id="textToPdfStatus" aria-live="polite"></p></div></div><div id="htmlToPdfToolContent" class="tab-content"><div class="page-header"><button class="back-button" data-target-tab="allFeaturesListContent"><i class="fas fa-arrow-left"></i>Back</button><h1 class="page-title">HTML to PDF Converter</h1><div class="placeholder"></div></div><div class="card generic-tool-wrapper"><header><h1>Convert HTML to PDF</h1><p>Paste HTML code below to convert it to a PDF document.</p></header><div class="form-group"><label for="htmlToPdfInput">HTML Code:</label><textarea id="htmlToPdfInput" placeholder="Paste your HTML code here..." style="min-height:150px" rows="8"></textarea></div><button id="convertHtmlToPdfButton" class="action-button-primary"><i class="fab fa-html5"></i>Convert to PDF</button><p class="status-message" id="htmlToPdfStatus" aria-live="polite"></p></div></div><div id="qrCodeGeneratorToolContent" class="tab-content"><div class="page-header"><button class="back-button" data-target-tab="allFeaturesListContent"><i class="fas fa-arrow-left"></i>Back</button><h1 class="page-title">QR Code Generator</h1><div class="placeholder"></div></div><div class="card generic-tool-wrapper"><header><h1>Create QR Codes</h1><p>Enter data and desired size to generate a QR code.</p></header><div class="form-group"><label for="qrDataInput">Data for QR Code:</label><input type="text" id="qrDataInput" placeholder="e.g., https://example.com or text"></div><div class="form-group"><label for="qrSizeInput">Size (pixels, e.g., 150-500):</label><input type="number" id="qrSizeInput" value="200" min="50" max="1000" placeholder="e.g., 200"></div><button id="generateQrCodeButton" class="action-button-primary"><i class="fas fa-qrcode"></i>Generate QR Code</button><p class="status-message" id="qrCodeStatus" aria-live="polite"></p><div id="qrCodeResultArea" class="qr-code-display results-area" style="text-align:center"></div><div class="file-actions"><button id="downloadQrCodeButton" class="action-button" style="display:none"><i class="fas fa-download"></i>Download QR</button></div></div></div><div id="slaCalculatorToolContent" class="tab-content"><div class="page-header"><button class="back-button" data-target-tab="allFeaturesListContent"><i class="fas fa-arrow-left"></i>Back</button><h1 class="page-title">SLA Calculator</h1><div class="placeholder"></div></div><div class="card generic-tool-wrapper"><header><h1>Calculate SLA Downtime</h1><p>Enter an uptime percentage to see the allowed downtime per day, week, month, and year.</p></header><div class="form-group"><label for="slaUptimePercent">SLA Uptime Percentage (e.g., 99.9):</label><input type="number" id="slaUptimePercent" step="0.001" min="0" max="100" placeholder="e.g., 99.9"></div><button id="calculateSlaDowntimeButton" class="action-button-primary"><i class="fas fa-calculator"></i>Calculate Allowed Downtime</button><p class="status-message" id="slaCalculatorStatus" aria-live="polite"></p><div id="slaCalculatorResultArea" class="results-area"></div></div></div><div id="ipInfoToolContent" class="tab-content"><div class="page-header"><button class="back-button" data-target-tab="allFeaturesListContent"><i class="fas fa-arrow-left"></i>Back</button><h1 class="page-title">IP Address Information</h1><div class="placeholder"></div></div><div class="card generic-tool-wrapper"><header><h1>Get IP Details</h1><p>Enter an IP address or leave blank to get details for your current IP.</p></header><div class="form-group"><label for="ipAddressInput">IP Address (leave blank for yours):</label><input type="text" id="ipAddressInput" placeholder="e.g., 8.8.8.8 or your public IP"></div><button id="fetchIpInfoButton" class="action-button-primary"><i class="fas fa-search"></i>Get IP Info</button><p class="status-message" id="ipInfoStatus" aria-live="polite"></p><div id="ipInfoResultArea" class="results-area"></div><button id="ipTellMeMoreButton" class="action-button" style="margin-top:10px;display:none"><i class="fas fa-info-circle"></i>Tell Me More About This IP</button></div></div><div id="jokeContent" class="tab-content"><div class="page-header"><button class="back-button" data-target-tab="allFeaturesListContent"><i class="fas fa-arrow-left"></i>Back</button><h1 class="page-title">Joke Teller</h1><div class="placeholder"></div></div><div class="card generic-tool-wrapper"><header><h1>Need a Laugh?</h1><p>Let me tell you a random joke!</p></header><button id="fetchJokeButton" class="action-button-primary" style="max-width:250px"><i class="fas fa-redo"></i>Get Another Joke!</button><p class="status-message" id="jokeStatus" aria-live="polite"></p><div id="jokeResultArea" class="results-area" style="text-align:center;min-height:100px"></div><div class="file-actions"><button id="readJokeButton" class="action-button" disabled="disabled"><i class="fas fa-volume-up"></i>Read</button><button id="libraryAddJokeButton" class="action-button" disabled="disabled"><i class="fas fa-plus"></i>Add to Library</button></div></div></div><div id="codeTesterToolContent" class="tab-content"><div class="page-header"><button class="back-button" data-target-tab="allFeaturesListContent"><i class="fas fa-arrow-left"></i>Back</button><h1 class="page-title">Code Tester (HTML)</h1><div class="placeholder"></div></div><div class="card generic-tool-wrapper"><header><h1>Test & View HTML</h1><p>Enter HTML code in the box below to see it rendered live. You can also download your code as an .html file.</p></header><div class="form-group"><label for="codeTesterCodeInput">HTML Code:</label><textarea id="codeTesterCodeInput" placeholder="Paste your HTML code here... e.g., <h1>Hello</h1><p>World</p>" style="min-height:200px" rows="10"></textarea></div><div class="file-actions" style="justify-content:space-around;margin-bottom:15px"><button id="renderHtmlButton" class="action-button"><i class="fas fa-play"></i>Test Code</button><button id="downloadHtmlButton" class="action-button"><i class="fas fa-download"></i>Download HTML</button></div><p class="status-message" id="codeTesterStatus" aria-live="polite"></p><div id="codeTesterRenderArea" title="HTML Render Area"><iframe id="codeTesterIframe" sandbox="allow-scripts allow-same-origin"></iframe></div></div></div><div id="moreContent" class="tab-content"><div class="page-header"><div class="placeholder"></div><h1 class="page-title">More Options</h1><div class="placeholder"></div></div><div id="moreMainPage" class="card"><ul class="more-options-list"><li><button id="moreSettingsButton"><i class="fas fa-cog"></i>App Settings</button></li><li><button id="moreMyLibraryButton"><i class="fas fa-swatchbook"></i>My Library</button></li><li><button id="moreUserGuideButton"><i class="fas fa-book-open"></i>User Guide</button></li><li><button id="morePrivacyButton"><i class="fas fa-user-secret"></i>Privacy Policy</button></li><li><button id="moreContactButton"><i class="fas fa-address-card"></i>Contact & About</button></li><li><button id="moreLogoutButton"><i class="fas fa-sign-out-alt"></i>Logout</button></li></ul></div><div id="settingsPage" class="more-subpage card" style="display:none"><button class="back-to-more action-button" data-target-main="moreMainPage" role="button" style="background:0 0;border:1px solid var(--border-color-theme);color:var(--text-color);padding:8px 12px;margin-bottom:15px;width:auto;display:inline-flex"><i class="fas fa-arrow-left"></i>Back to More</button><h3>App Settings</h3><ul class="more-options-list"><li><button id="themeToggleButtonMore"><i class="fas fa-palette"></i>Switch Theme</button></li><li><button id="resetPermissionsButton"><i class="fas fa-undo-alt"></i>Reset Permissions</button></li></ul><div class="card" style="margin-top:20px;background-color:var(--input-bg-color)"><h3>Text-to-Speech Settings</h3><p style="font-size:.9em;opacity:.8">Set a default voice for quick system messages and fallbacks (does not affect the main AI voice quality).</p><div class="form-group" style="margin-top:10px"><label for="globalVoiceSelect">Default System Voice:</label><select id="globalVoiceSelect" class="generic-tool-wrapper"></select></div></div></div><div id="myLibraryPage" class="more-subpage card" style="display:none"><button class="back-to-more action-button" data-target-main="moreMainPage" role="button" style="background:0 0;border:1px solid var(--border-color-theme);color:var(--text-color);padding:8px 12px;margin-bottom:15px;width:auto;display:inline-flex"><i class="fas fa-arrow-left"></i>Back to More</button><h3>My Library</h3><p>Here are your saved items. This data is stored locally on your device.</p><div class="file-actions" style="margin-bottom:20px"><button id="clearLibraryButton" class="action-button" style="background-color:#d32f2f;color:#fff"><i class="fas fa-trash"></i>Clear Entire Library</button></div><div id="libraryDisplayArea" class="results-area"><p>Your library is currently empty. Use the "Add to Library" button in various tools to save items here.</p></div></div><div id="userGuidePage" class="more-subpage card" style="display:none"><button class="back-to-more action-button" data-target-main="moreMainPage" role="button" style="background:0 0;border:1px solid var(--border-color-theme);color:var(--text-color);padding:8px 12px;margin-bottom:15px;width:auto;display:inline-flex"><i class="fas fa-arrow-left"></i>Back to More</button><h3>How to Use THIRD EYE</h3><div id="userGuideAudioPlayerMore" style="text-align:center;margin-bottom:20px"><p>Tap to hear a quick overview of the app:</p><button id="playAppGuideMore" class="action-button"><i class="fas fa-play"></i>Play App Guide Audio</button></div><ul id="userGuideTextList" style="margin-top:15px;font-size:.9em;list-style-type:disc;padding-left:20px"></ul></div><div id="privacyPolicyPage" class="more-subpage card" style="display:none"><button class="back-to-more action-button" data-target-main="moreMainPage" role="button" style="background:0 0;border:1px solid var(--border-color-theme);color:var(--text-color);padding:8px 12px;margin-bottom:15px;width:auto;display:inline-flex"><i class="fas fa-arrow-left"></i>Back to More</button><h3>Privacy Policy</h3><p><strong>Last Updated: July 2, 2025</strong></p><p>Your privacy is important to us. This THIRD EYE application uses Firebase Authentication for user accounts. When you register or log in with email/password or phone number, this information is managed by Firebase according to their privacy policy.</p><p><strong>Information We Handle:</strong></p><ul><li>Authentication data (email, hashed password, phone number, user ID) via Firebase.</li><li>App preferences like theme and saved library items are stored locally in your browser's localStorage.</li></ul><p><strong>Third-Party APIs:</strong>Features like Translation, IP Info, Maps, and the Assistant use external APIs. Your interactions with these are subject to the respective third-party privacy policies. This app acts as an interface and does not persistently store your query data sent to these services on a server.</p><p><strong>Permissions:</strong>Microphone, Location, and Camera permissions are requested only when you use features that require them. This app does not store any media or location data on a server. You can manage these permissions in your browser settings at any time.</p><p>We do not sell or share your personal data. As this is a comprehensive tool, please use external API-dependent features with awareness.</p></div><div id="contactDetailsPage" class="more-subpage card" style="display:none"><button class="back-to-more action-button" data-target-main="moreMainPage" role="button" style="background:0 0;border:1px solid var(--border-color-theme);color:var(--text-color);padding:8px 12px;margin-bottom:15px;width:auto;display:inline-flex"><i class="fas fa-arrow-left"></i>Back to More</button><h3>Contact & About</h3><p>Your thoughts are vital! Reach out via:</p><ul style="list-style:none;padding-left:0"><li><strong>WhatsApp:</strong><a href="https://chat.whatsapp.com/L6IIoNHie3WCCgFFQWUSZJ" target="_blank" rel="noopener">Join Group</a></li><li><strong>YouTube:</strong><a href="https://youtube.com/@informationtechnology3690?si=lthypKFXA6qMhvgK" target="_blank" rel="noopener">Visit Channel</a></li><li><strong>Developer:</strong><a href="tel:7396350322">Call Teja (7396350322)</a></li></ul><p style="margin-top:20px;text-align:center;font-style:italic">This application was proudly developed by:<strong>Teja</strong></p></div></div></main><div id="autoplayUnlockMessage" style="display:none;position:fixed;bottom:70px;left:50%;transform:translateX(-50%);background:var(--accent-color-theme);color:var(--bg-color);padding:10px 15px;border-radius:8px;z-index:10003;font-size:.9em;text-align:center">Tap screen to enable audio.</div><div id="assistantListeningIndicator" class="assistant-listening-indicator" aria-live="assertive" aria-atomic="true">THIRD EYE Listening...</div><button id="floatingAssistantButton" class="app-hidden" aria-label="Activate THIRD EYE Assistant">🤖</button><nav class="tab-bar app-hidden"><button class="tab-button active" data-tab="homeContent" aria-label="Home"><i class="fas fa-home"></i><span class="tab-label">Home</span></button><button class="tab-button" data-tab="allFeaturesListContent" aria-label="All Features"><i class="fas fa-th-large"></i><span class="tab-label">Features</span></button><button class="tab-button" data-tab="moreContent" aria-label="More options"><i class="fas fa-ellipsis-h"></i><span class="tab-label">More</span></button><button class="tab-button" id="appExplainAudioButton" aria-label="Play app instructions audio"><i class="fas fa-headphones-alt"></i><span class="tab-label">Explain</span></button></nav><script type="module">// THIRD EYE - v12.7.3 (Location Hub Fix)

const fbAuth = window.firebaseAuth; 
const { 
    createUserWithEmailAndPassword, 
    signInWithEmailAndPassword, 
    signOut, 
    onAuthStateChanged,
    sendPasswordResetEmail,
    RecaptchaVerifier,
    signInWithPhoneNumber
} = window.firebaseAuthFunctions; 

// --- API Configuration ---
const BACKEND_URL = "https://threerd-eye.onrender.com/api/main";
const API_KEYS = {
    IPINFO: "de0d7b59c63b1e"
};

document.addEventListener('DOMContentLoaded', () => {
    const ui = {
        soundPromptOverlay: document.getElementById('soundPromptOverlay'),
        soundPromptOkButton: document.getElementById('soundPromptOkButton'),
        loginOverlay: document.getElementById('loginOverlay'),
        emailAuthContainer: document.getElementById('emailAuthContainer'),
        phoneAuthContainer: document.getElementById('phoneAuthContainer'),
        switchToPhoneAuth: document.getElementById('switchToPhoneAuth'),
        switchToEmailAuth: document.getElementById('switchToEmailAuth'),
        firebaseLoginForm: document.getElementById('firebaseLoginForm'), 
        emailInput: document.getElementById('emailInput'),
        passwordInput: document.getElementById('passwordInput'),
        loginButton: document.getElementById('loginButton'), 
        registerButton: document.getElementById('registerButton'),
        phoneInput: document.getElementById('phoneInput'),
        sendOtpButton: document.getElementById('sendOtpButton'),
        otpContainer: document.getElementById('otpContainer'),
        otpInput: document.getElementById('otpInput'),
        verifyOtpButton: document.getElementById('verifyOtpButton'),
        recaptchaContainer: document.getElementById('recaptcha-container'),
        forgotPasswordLink: document.getElementById('forgotPasswordLink'),
        loginError: document.getElementById('loginError'),
        
        welcomeMessageOverlay: document.getElementById('welcomeMessageOverlay'),
        appHeader: document.querySelector('.app-header'),
        topRightMoreButton: document.getElementById('topRightMoreButton'),
        topRightDropdownMenu: document.getElementById('topRightDropdownMenu'),
        tabBar: document.querySelector('.tab-bar'),
        tabButtons: Array.from(document.querySelectorAll('.tab-bar .tab-button:not(#appExplainAudioButton)')),
        tabContents: document.querySelectorAll('.tab-content'),
        mainContentArea: document.getElementById('mainContentArea'),
        homeWelcomeMessage: document.getElementById('homeWelcomeMessage'),

        pageBackButtons: document.querySelectorAll('.page-header .back-button'),
        playAppGuideAllFeatures: document.getElementById('playAppGuideAllFeatures'),

        initialPlayOverlay: document.getElementById('initialPlayOverlay'),
        playInitialInstructionsButton: document.getElementById('playInitialInstructionsButton'),
        vocarooPlayer: document.getElementById('vocarooInstructionPlayer'),
        processingSoundAudioPlayer: document.getElementById('processingSoundAudio'),
        welcomeSoundAudioPlayer: document.getElementById('welcomeSoundAudio'),
        aiAudioPlayer: document.getElementById('aiAudioPlayer'),
        robotMouth: document.querySelector('#robotAnimation .robot-mouth'),
        appExplainAudioButton: document.getElementById('appExplainAudioButton'),
        autoplayUnlockMessage: document.getElementById('autoplayUnlockMessage'),
        
        assistantTool: {
            commandInput: document.getElementById('assistantCommandInput'),
            submitCommandButton: document.getElementById('submitAssistantCommand'),
            responseArea: document.getElementById('assistantResponseOutput'),
            statusMessage: document.getElementById('assistantStatusMessage'),
            listeningIndicator: document.getElementById('assistantListeningIndicator'),
            floatingButton: document.getElementById('floatingAssistantButton')
        },
        ttsTool: {
            textToSpeakInput: document.getElementById('textToSpeak'), 
            aiVoiceSelect: document.getElementById('aiVoiceSelect'),
            speakButton: document.getElementById('speakButton'), 
            stopButton: document.getElementById('stopButton'),
            statusMessage: document.getElementById('ttsStatusMessage'),
            copyTextButton: document.getElementById('ttsCopyTextButton'), 
            downloadAudioButton: document.getElementById('ttsDownloadAudioButton'),
            shareTextButton: document.getElementById('ttsShareTextButton')
        },
        translatorTool: {
            fromLangSelect: document.getElementById('translateFromLang'), 
            toLangSelect: document.getElementById('translateToLang'),
            swapButton: document.getElementById('swapLanguagesButton'), 
            inputTextArea: document.getElementById('translationInput'),
            outputTextArea: document.getElementById('translationOutput'), 
            translateButton: document.getElementById('translateButton'),
            statusMessage: document.getElementById('translationStatus'), 
            readButton: document.getElementById('readTranslatedTextButton'),
            copyButton: document.getElementById('copyTranslatedTextButton'),
        },
        photoReaderTool: { 
            fileInput: document.getElementById('photoFile'), 
            preview: document.getElementById('photoPreview'), 
            statusMessage: document.getElementById('photoReaderStatus'), 
            extractedTextArea: document.getElementById('photoExtractedText'), 
            readButton: document.getElementById('readPhotoTextButton'), 
            copyButton: document.getElementById('copyPhotoTextButton'),
            shareButton: document.getElementById('sharePhotoTextButton'),
            stopButton: document.getElementById('stopPhotoTextButton'),
            cameraContainer: document.getElementById('photoCameraContainer'),
            cameraFeed: document.getElementById('photoCameraFeed'),
            startCameraButton: document.getElementById('startCameraButtonPhoto'),
            captureButton: document.getElementById('capturePhotoButton'),
            cameraCanvas: document.getElementById('photoCanvas')
        },
        pdfReaderTool: { 
            fileInput: document.getElementById('pdfFile'), 
            statusMessage: document.getElementById('pdfReaderStatus'), 
            extractedTextArea: document.getElementById('pdfExtractedText'), 
            readPageButton: document.getElementById('readPdfPageButton'), 
            analyzeButton: document.getElementById('pdfAnalyzePageButton'),
            copyPageButton: document.getElementById('pdfCopyPageButton'),
            downloadAllTextButton: document.getElementById('pdfDownloadAllTextButton'),
            downloadAllAudioButton: document.getElementById('pdfDownloadAllAudioButton'),
            shareAllTextButton: document.getElementById('pdfShareAllTextButton'),
            prevPageButton: document.getElementById('pdfPrevPageButton'), 
            nextPageButton: document.getElementById('pdfNextPageButton'), 
            pageIndicator: document.getElementById('pdfPageIndicator'), 
            navigationControls: document.querySelector('#pdfReaderContent .pdf-navigation'), 
            toolWrapper: document.querySelector('#pdfReaderContent .file-reader-tool-wrapper')
        },
        textToImageTool: { 
            promptInput: document.getElementById('imagePrompt'), 
            generateButton: document.getElementById('generateImageButton'), 
            statusMessage: document.getElementById('imageGeneratorStatus'), 
            imageElement: document.getElementById('generatedImage'), 
            resultContainer: document.getElementById('imageResultContainer'), 
            actionButtons: document.getElementById('imageActionButtons'), 
            regenerateButton: document.getElementById('regenerateImageButton'), 
            downloadButton: document.getElementById('downloadImageButton'),
            libraryAddButton: document.getElementById('libraryAddImageButton')
        },
        cashReaderTool: { 
            fileInput: document.getElementById('cashFile'), 
            preview: document.getElementById('cashPreview'), 
            statusMessage: document.getElementById('cashReaderStatus'), 
            resultArea: document.getElementById('cashResultArea'), 
            readButton: document.getElementById('readCashResultButton'), 
            cameraContainer: document.getElementById('cashCameraContainer'), 
            cameraFeed: document.getElementById('cashCameraFeed'), 
            startCameraButton: document.getElementById('startCameraButtonCash'), 
            captureCashButton: document.getElementById('captureCashButton'), 
            cameraCanvas: document.getElementById('cashCanvas')
        },
        objectIdentifierTool: {
            fileInput: document.getElementById('objectFile'),
            preview: document.getElementById('objectPreview'),
            statusMessage: document.getElementById('objectIdentifierStatus'),
            resultArea: document.getElementById('objectResultArea'),
            readButton: document.getElementById('readObjectResultButton'),
            cameraContainer: document.getElementById('objectCameraContainer'),
            cameraFeed: document.getElementById('objectCameraFeed'),
            startCameraButton: document.getElementById('startCameraButtonObject'),
            captureButton: document.getElementById('captureObjectButton'),
            cameraCanvas: document.getElementById('objectCanvas')
        },
        documentScannerTool: {
            fileInput: document.getElementById('docFile'),
            preview: document.getElementById('docPreview'),
            statusMessage: document.getElementById('docScannerStatus'),
            resultArea: document.getElementById('docResultArea'),
            readButton: document.getElementById('readDocResultButton'),
            copyButton: document.getElementById('copyDocResultButton'),
            cameraContainer: document.getElementById('docCameraContainer'),
            cameraFeed: document.getElementById('docCameraFeed'),
            startCameraButton: document.getElementById('startCameraButtonDoc'),
            captureButton: document.getElementById('captureDocButton'),
            cameraCanvas: document.getElementById('docCanvas')
        },
        locationTool: {
            getLocationButton: document.getElementById('getLocationButton'), 
            statusMessage: document.getElementById('locationStatus'),
            addressSpan: document.getElementById('locationAddress'), 
            coordsSpan: document.getElementById('locationCoords'),
            mapContainer: document.getElementById('mapContainer'), 
            readButton: document.getElementById('readLocationButton'),
            resultCard: document.getElementById('locationResultCard'), 
            setReminderButton: document.getElementById('setReminderButton'),
            reminderModalOverlay: document.getElementById('reminderModalOverlay'), 
            reminderOptions: document.querySelector('#reminderModalOverlay .reminder-options'),
            closeReminderModal: document.getElementById('closeReminderModalButton'), 
            activeReminderStatus: document.getElementById('activeReminderStatus'),
            nearbySearchInput: document.getElementById('nearbySearchInput'), 
            executeSearchButton: document.getElementById('executeSearchButton'),
            nearbySearchResults: document.getElementById('nearbySearchResults'),
            nearbyStatusMessage: document.getElementById('nearbyStatusMessage'),
            tellMeMoreButton: document.getElementById('locationTellMeMoreButton')
        },
        aroundMeTool: {
            findButton: document.getElementById('aroundMeFindButton'),
            resultsArea: document.getElementById('aroundMeResultsArea'),
            statusMessage: document.getElementById('aroundMeStatus')
        },
        transitHubTool: {
            busCompanySelect: document.getElementById('busCompany'),
            busRouteInput: document.getElementById('busRoute'),
            busStopIdInput: document.getElementById('busStopId'),
            fetchBusDataButton: document.getElementById('fetchBusDataButton'),
            busDataStatus: document.getElementById('busDataStatus'),
            busDataResultArea: document.getElementById('busDataResultArea'),
            konkanTrainNoInput: document.getElementById('konkanTrainNo'),
            fetchKonkanTrainButton: document.getElementById('fetchKonkanTrainButton'),
            konkanTrainStatus: document.getElementById('konkanTrainStatus'),
            konkanTrainResultArea: document.getElementById('konkanTrainResultArea'),
            sbbStationInput: document.getElementById('sbbStation'),
            fetchSbbDataButton: document.getElementById('fetchSbbDataButton'),
            sbbDataStatus: document.getElementById('sbbDataStatus'),
            sbbDataResultArea: document.getElementById('sbbDataResultArea'),
            fetchIamSmartButton: document.getElementById('fetchIamSmartButton'),
            iamSmartStatus: document.getElementById('iamSmartStatus'),
            iamSmartResultArea: document.getElementById('iamSmartResultArea'),
        },
        newsTool: { 
            getNewsButton: document.getElementById('getNewsButton'), 
            statusMessage: document.getElementById('newsStatus'), 
            resultArea: document.getElementById('newsResultArea'), 
            readButton: document.getElementById('readNewsButton'),
            categorySelect: document.getElementById('newsCategorySelect'), 
            countrySelect: document.getElementById('newsCountrySelect')
        },
        textToPdfTool: { 
            textInput: document.getElementById('textForPdf'), 
            generateButton: document.getElementById('generatePdfButton'), 
            statusMessage: document.getElementById('textToPdfStatus'), 
        },
        htmlToPdfTool: {
            input: document.getElementById('htmlToPdfInput'),
            convertButton: document.getElementById('convertHtmlToPdfButton'),
            statusMessage: document.getElementById('htmlToPdfStatus'),
        },
        qrCodeGeneratorTool: {
            dataInput: document.getElementById('qrDataInput'),
            sizeInput: document.getElementById('qrSizeInput'),
            generateButton: document.getElementById('generateQrCodeButton'),
            statusMessage: document.getElementById('qrCodeStatus'),
            resultArea: document.getElementById('qrCodeResultArea'),
            downloadButton: document.getElementById('downloadQrCodeButton'),
        },
        slaCalculatorTool: {
            uptimePercentInput: document.getElementById('slaUptimePercent'),
            calculateButton: document.getElementById('calculateSlaDowntimeButton'),
            statusMessage: document.getElementById('slaCalculatorStatus'),
            resultArea: document.getElementById('slaCalculatorResultArea'),
        },
        ipInfoTool: {
            ipAddressInput: document.getElementById('ipAddressInput'),
            fetchButton: document.getElementById('fetchIpInfoButton'),
            statusMessage: document.getElementById('ipInfoStatus'),
            resultArea: document.getElementById('ipInfoResultArea'),
            tellMeMoreButton: document.getElementById('ipTellMeMoreButton')
        },
        jokeTool: {
            fetchJokeButton: document.getElementById('fetchJokeButton'),
            jokeStatus: document.getElementById('jokeStatus'),
            jokeResultArea: document.getElementById('jokeResultArea'),
            readJokeButton: document.getElementById('readJokeButton'),
            libraryAddButton: document.getElementById('libraryAddJokeButton')
        },
        codeTesterTool: { 
            codeInput: document.getElementById('codeTesterCodeInput'),
            renderButton: document.getElementById('renderHtmlButton'),
            downloadButton: document.getElementById('downloadHtmlButton'),
            statusMessage: document.getElementById('codeTesterStatus'),
            iframe: document.getElementById('codeTesterIframe')
        },
        calculatorTool: {
            display: document.getElementById('calculatorDisplay'),
            buttons: document.querySelectorAll('#calculatorContent .calculator-buttons button')
        },
        quotationsTool: {
            fetchButton: document.getElementById('fetchQuoteButton'),
            statusMessage: document.getElementById('quoteStatus'),
            quoteCategoryInput: document.getElementById('quoteCategoryInput'),
            quoteTextElement: document.getElementById('quoteText'),
            quoteAuthorElement: document.getElementById('quoteAuthor'),
            readButton: document.getElementById('readQuoteButton'),
            copyButton: document.getElementById('copyQuoteButton'),
            shareButton: document.getElementById('shareQuoteButton'),
            libraryAddButton: document.getElementById('libraryAddQuoteButton')
        },
        moreSection: { 
            mainPage: document.getElementById('moreMainPage'), 
            settingsButton: document.getElementById('moreSettingsButton'),
            myLibraryButton: document.getElementById('moreMyLibraryButton'),
            userGuideButton: document.getElementById('moreUserGuideButton'),
            privacyButton: document.getElementById('morePrivacyButton'),
            contactButton: document.getElementById('moreContactButton'),
            logoutButton: document.getElementById('moreLogoutButton'), 
            subpages: document.querySelectorAll('.more-subpage'), 
            settingsPage: document.getElementById('settingsPage'),
            myLibraryPage: document.getElementById('myLibraryPage'),
            userGuidePage: document.getElementById('userGuidePage'),
            privacyPolicyPage: document.getElementById('privacyPolicyPage'),
            contactDetailsPage: document.getElementById('contactDetailsPage'),
            themeToggleButtonMore: document.getElementById('themeToggleButtonMore'),
            resetPermissionsButton: document.getElementById('resetPermissionsButton'),
            globalVoiceSelect: document.getElementById('globalVoiceSelect'),
            libraryDisplayArea: document.getElementById('libraryDisplayArea'),
            clearLibraryButton: document.getElementById('clearLibraryButton'),
            playAppGuideMore: document.getElementById('playAppGuideMore'),
            userGuideTextList: document.getElementById('userGuideTextList'),
            backLinks: document.querySelectorAll('.more-subpage .back-to-more') 
        },
        dropdownSettingsButton: document.getElementById('dropdownSettingsButton'),
        dropdownLibraryButton: document.getElementById('dropdownLibraryButton'),
        dropdownPrivacyButton: document.getElementById('dropdownPrivacyButton'),
        dropdownContactButton: document.getElementById('dropdownContactButton'),
        dropdownUserGuideButton: document.getElementById('dropdownUserGuideButton'),
        themeToggleButtonDropdown: document.getElementById('themeToggleButtonDropdown'),
        logoutButtonDropdown: document.getElementById('logoutButtonDropdown') 
    };

    // --- State Variables ---
    const speechSynthesis = window.speechSynthesis;
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let systemVoices = []; 
    let isVocarooPlayingIntent = false; let userInteractedOnce = false;
    let recognition = null; let isListeningForCommand = false; let assistantContinuousListening = false;
    let currentPdfDoc = null; let pdfPagesText = []; let currentPdfPageIndex = 0;
    let currentNewsArticles = []; let locationReminderIntervalId = null;
    let activeCameraStream = null; let lastKnownPosition = null;
    let currentJokeText = ""; let currentQuote = {text: "", author: ""};
    let lastIpInfo = null;
    let recentJokes = []; // For preventing joke repetition
    let recentQuotes = []; // For preventing quote repetition
    
    // Leaflet.js map state
    let leafletMap = null;
    let userMarker = null;
    let searchMarkers = new L.FeatureGroup();

    const appInfo = { 
        name: "THIRD EYE", version: "12.7.3", creator: "Teja", 
        purpose: "Your All-in-One Companion for Productivity, Entertainment, Learning, and daily assistance.", 
        guides: { 
            assistant: "Tap the floating 🤖 button or double-tap the screen to talk to me. I can help with commands like 'go to news', 'how does the scanner work', or answer general knowledge questions.",
            objectID: "Go to 'Object Identifier', point your camera at an item, and tap capture. I will tell you what it is.",
            docScan: "Go to 'Document Scanner', take a picture of a document, and I'll read out the contents and key details.",
            cashReader: "Go to 'Cash Reader', tap 'Use Camera' or 'From Photos'. The Vision AI will analyze the image and identify the currency note. (Experimental, do not use for financial transactions).", 
            location: "In 'Location Hub', find your address on the interactive map, search for nearby places or global landmarks, or set time-based reminders.",
            imageReader: "Go to 'Image to Text Reader', use your camera or choose an image, and I'll extract the text found within it using advanced AI.", 
            pdfReader: "In 'PDF Reader', pick a PDF. It loads quickly. Navigate pages, and I'll read the text on demand. You can also analyze, download, or share the entire document's text.",
            tts: "Go to 'Text-to-Audio', type text, choose a voice, and hit 'Read Aloud'. You can also download the audio file or copy the text.",
            imageGen: "Go to 'Image Generator', describe the image you want, and hit 'Generate Image'.",
            news: "Go to 'News Updates', select a category and country, then tap 'Fetch News' to get the latest headlines.", 
            myLibrary: "Go to 'My Library' (from the 'More' tab) to view and manage all your saved items like quotes, jokes, and text snippets."
        } 
    };
    const TRANSLATION_LANGUAGES = {'auto':'Auto Detect','en':'English','hi':'Hindi','es':'Spanish','fr':'French','de':'German','it':'Italian','ja':'Japanese','ko':'Korean','pt':'Portuguese','ru':'Russian','zh-CN':'Chinese (Simplified)','ar':'Arabic','te':'Telugu','ta':'Tamil','mr':'Marathi','bn':'Bengali','gu':'Gujarati','kn':'Kannada','ml':'Malayalam','pa':'Punjabi','ur':'Urdu'};
    const NEWS_COUNTRIES = { 'in': 'India', 'us': 'USA', 'gb': 'United Kingdom', 'au': 'Australia', 'ca': 'Canada', 'cn': 'China', 'de': 'Germany', 'fr': 'France', 'jp': 'Japan', 'ru': 'Russia', 'sa': 'Saudi Arabia', 'ae': 'UAE', 'hk': 'Hong Kong'};
    const NEWS_CATEGORIES = { 'top': 'Top Headlines', 'technology': 'Technology', 'business': 'Business', 'sports': 'Sports', 'health': 'Health', 'science': 'Science', 'entertainment': 'Entertainment' };

    function log(message) { console.log(`[TEYE v${appInfo.version}] ${new Date().toLocaleTimeString()}: ${message}`); }
    
    function playProcessingSound(){
        if (!userInteractedOnce) {
            ui.soundPromptOverlay.style.cssText += 'visibility:visible;opacity:1;display:flex;';
            return;
        }
        if(ui.processingSoundAudioPlayer)ui.processingSoundAudioPlayer.play().catch(e=>log("Processing sound error: "+e.message));
    }

    function stopProcessingSound(){if(ui.processingSoundAudioPlayer){ui.processingSoundAudioPlayer.pause();ui.processingSoundAudioPlayer.currentTime=0;}}

    async function manageProcessingIndicator(asyncTask) {
        playProcessingSound();
        try {
            await asyncTask();
        } finally {
            // This block ensures the sound stops regardless of whether the task succeeded or failed.
            stopProcessingSound();
        }
    }
    
    async function queryAI(prompt, isVisionRequest = false, imageDataUrl = null) {
        let requestBody;

        if (isVisionRequest && imageDataUrl) {
            requestBody = {
                service: "vision",
                prompt: prompt,
                isVisionRequest: true,
                imageDataUrl: imageDataUrl
            };
        } else {
            requestBody = {
                service: "chat",
                prompt: prompt
            };
        }

        try {
            const response = await fetch(BACKEND_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ error: "Unknown server error." }));
                log(`Backend Error: Status ${response.status}, Message: ${errorData.error}`);
                throw new Error(errorData.error || "The AI processor encountered a critical error. Please try again.");
            }

            const data = await response.json();
            const reply = data.reply;
            if (!reply) throw new Error("AI processor returned an empty or invalid response.");

            log("AI processor request successful.");
            return reply;
        } catch (error) {
            log(`Backend Fetch Error: ${error.message}`);
            // FIX: This error message is now more specific to the CORS/spin-down issue.
            if (error instanceof TypeError) {
                throw new Error("Connection to AI server failed. The free server may be spinning up (takes ~50s) or the request was blocked by a network policy (CORS). Please wait a minute and try again.");
            }
            throw error; 
        }
    }


    // --- Firebase Authentication Logic ---
    onAuthStateChanged(fbAuth, (user) => {
        if (user) { 
            let displayName = "User";
            if (user.isAnonymous) { displayName = "Guest User"; } 
            else if (user.phoneNumber) { displayName = user.phoneNumber; }
            else if (user.email) { displayName = user.email.split('@')[0]; }
            
            log(`User ${displayName} signed in with UID: ${user.uid}`);
            firebaseLoginSuccess(displayName); 
        } else { 
            ui.loginOverlay.style.display = 'flex'; 
            ui.loginOverlay.style.opacity = '1';
            ui.loginOverlay.style.visibility = 'visible';
            ui.appHeader.classList.add('app-hidden');
            ui.tabBar.classList.add('app-hidden');
            ui.mainContentArea.classList.add('app-hidden');
            ui.assistantTool.floatingButton.classList.add('app-hidden');
            log("User is signed out. Showing login screen.");
        }
    });
    
    ui.switchToPhoneAuth.addEventListener('click', () => { ui.emailAuthContainer.classList.add('app-hidden'); ui.phoneAuthContainer.classList.remove('app-hidden'); setupRecaptchaVerifier(); ui.loginError.textContent = ''; });
    ui.switchToEmailAuth.addEventListener('click', () => { ui.phoneAuthContainer.classList.add('app-hidden'); ui.emailAuthContainer.classList.remove('app-hidden'); ui.loginError.textContent = ''; });
    ui.firebaseLoginForm.addEventListener('submit', (e) => e.preventDefault()); 
    ui.loginButton.addEventListener('click', () => { const email = ui.emailInput.value.trim(), password = ui.passwordInput.value; ui.loginError.textContent = 'Logging in...'; if (!email || !password) { ui.loginError.textContent = 'Email and password are required.'; return; } signInWithEmailAndPassword(fbAuth, email, password).catch((error) => { log(`Firebase Login Error: ${error.code} - ${error.message}`); handleFirebaseAuthError(error); }); });
    ui.registerButton.addEventListener('click', () => { const email = ui.emailInput.value.trim(), password = ui.passwordInput.value; ui.loginError.textContent = 'Registering...'; if (!email || !password) { ui.loginError.textContent = 'Email and password are required.'; return; } if (password.length < 6) { ui.loginError.textContent = 'Password must be at least 6 characters.'; return; } createUserWithEmailAndPassword(fbAuth, email, password).then(() => ui.loginError.textContent = 'Registration successful!').catch((error) => { log(`Firebase Registration Error: ${error.code} - ${error.message}`); handleFirebaseAuthError(error); }); });
    ui.forgotPasswordLink.addEventListener('click', () => { const email = ui.emailInput.value.trim(); if (!email) { ui.loginError.textContent = 'Please enter your email address.'; speakSystemMessage('Please enter email.'); return; } ui.loginError.textContent = 'Sending password reset email...'; sendPasswordResetEmail(fbAuth, email).then(() => { ui.loginError.textContent = 'Password reset email sent!'; speakSystemMessage('Password reset email sent.'); }).catch((error) => { log(`Firebase Forgot Password Error: ${error.code}`); handleFirebaseAuthError(error); }); });
    function setupRecaptchaVerifier() { ui.recaptchaContainer.innerHTML = ''; try { window.recaptchaVerifier = new RecaptchaVerifier(fbAuth, ui.recaptchaContainer, { 'size': 'normal', 'callback': () => { ui.sendOtpButton.disabled = false; }, 'expired-callback': () => { ui.sendOtpButton.disabled = true; } }); window.recaptchaVerifier.render().then(() => ui.sendOtpButton.disabled = false).catch(err => { ui.loginError.textContent = "Could not show verification widget."; ui.sendOtpButton.disabled = true; }); } catch (e) { ui.loginError.textContent = "Failed to set up phone verification."; } ui.sendOtpButton.disabled = true; }
    ui.sendOtpButton.addEventListener('click', () => { const phoneNumber = ui.phoneInput.value, appVerifier = window.recaptchaVerifier; if (!phoneNumber || !appVerifier) return; ui.loginError.textContent = "Sending verification code..."; signInWithPhoneNumber(fbAuth, phoneNumber, appVerifier).then((confirmationResult) => { window.confirmationResult = confirmationResult; ui.loginError.textContent = 'Verification code sent!'; speakSystemMessage("Verification code sent."); ui.otpContainer.classList.remove('app-hidden'); }).catch((error) => { ui.loginError.textContent = `Error: ${error.code}`; if (window.grecaptcha) grecaptcha.reset(); }); });
    ui.verifyOtpButton.addEventListener('click', () => { const code = ui.otpInput.value; if (!code || code.length !== 6) return; ui.loginError.textContent = 'Verifying...'; window.confirmationResult.confirm(code).catch((error) => handleFirebaseAuthError(error)); });
    const performLogout = () => signOut(fbAuth).catch((error) => { log(`Sign Out Error: ${error.code}`); alert("Error signing out."); });
    ui.logoutButtonDropdown.addEventListener('click', performLogout); ui.moreSection.logoutButton.addEventListener('click', performLogout);
    function handleFirebaseAuthError(error) { let message = "An unknown error occurred."; switch (error.code) { case "auth/invalid-email": message = "Invalid email format."; break; case "auth/user-disabled": message = "This account has been disabled."; break; case "auth/user-not-found": message = "No user found with this email."; break; case "auth/wrong-password": message = "Incorrect password."; break; case "auth/email-already-in-use": message = "This email is already registered."; break; case "auth/weak-password": message = "Password must be at least 6 characters."; break; case "auth/network-request-failed": message = "Network error. Check connection."; break; case "auth/invalid-phone-number": message = "Invalid phone number format."; break; case "auth/invalid-verification-code": message = "Incorrect verification code."; break; default: message = error.message.replace('Firebase: ', ''); } ui.loginError.textContent = message; speakSystemMessage(message); }
    function firebaseLoginSuccess(displayName){ ui.loginOverlay.style.opacity='0'; ui.loginOverlay.style.visibility='hidden'; ui.homeWelcomeMessage.textContent = `Welcome, ${displayName}!`; localStorage.setItem('loggedInUserDisplayName', displayName); ui.welcomeMessageOverlay.textContent=`Welcome, ${displayName}! Logged in.`; ui.welcomeMessageOverlay.style.display='block'; setTimeout(()=>{ ui.loginOverlay.style.display='none'; finishInitialization(); }, 1200); }
    
    // --- CRITICAL PERMISSION FIX ---
    async function requestPermission(permissionName) {
        // Map simple names to the required Permission API names.
        const permAPIMap = { 'microphone': 'microphone', 'camera': 'camera', 'location': 'geolocation' };
        const apiName = permAPIMap[permissionName];
        if (!apiName) return false;
    
        try {
            // Use the Permissions API to query the current state.
            const permissionStatus = await navigator.permissions.query({ name: apiName });
    
            if (permissionStatus.state === 'granted') {
                log(`${permissionName} permission is already granted.`);
                return true;
            }
    
            if (permissionStatus.state === 'denied') {
                log(`${permissionName} permission is permanently denied.`);
                alert(`Permission for ${permissionName} is blocked. You must enable it in your browser's site settings for this feature to work.`);
                return false;
            }
    
            // If state is 'prompt', we need to request it.
            if (permissionStatus.state === 'prompt') {
                log(`Prompting for ${permissionName} permission.`);
                let stream;
                try {
                    if (permissionName === 'location') {
                        await new Promise((resolve, reject) => navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 10000 }));
                    } else {
                         stream = await navigator.mediaDevices.getUserMedia({ [permissionName === 'microphone' ? 'audio' : 'video']: true });
                         stream.getTracks().forEach(track => track.stop()); // Immediately stop the track, we just wanted the permission.
                    }
                    log(`${permissionName} permission granted upon request.`);
                    return true;
                } catch (err) {
                    log(`${permissionName} permission denied by user upon request.`);
                    return false; // User clicked "Block".
                }
            }
        } catch (error) {
            log(`Error requesting permission for ${permissionName}: ${error}`);
            // Fallback for browsers that might not fully support the Permissions API for all types.
            try {
                if (permissionName === 'location') {
                    await new Promise((resolve, reject) => navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 10000 }));
                    return true;
                }
                let stream = await navigator.mediaDevices.getUserMedia({ [permissionName === 'microphone' ? 'audio' : 'video']: true });
                stream.getTracks().forEach(track => track.stop());
                return true;
            } catch (fallbackError) {
                alert(`Could not get permission for ${permissionName}. Please check your browser settings.`);
                return false;
            }
        }
        return false;
    }

    function finishInitialization(){
        if(ui.permissionsOverlay) ui.permissionsOverlay.style.display='none';
        document.querySelectorAll('.app-header, .tab-bar, .content-area, #floatingAssistantButton').forEach(el => el.classList.remove('app-hidden'));
        initializeAppAfterLoginAndPermissions();
    }
    
    function applyTheme(th){
        document.body.className=th+'-theme';
        localStorage.setItem('appTheme',th);
        const themeText = `<i class="fas fa-palette"></i> Switch to ${th==='dark'?'Light':'Dark'} Theme`;
        ui.moreSection.themeToggleButtonMore.innerHTML = themeText;
        ui.themeToggleButtonDropdown.innerHTML = themeText;
    }
    const themeToggleButtons = [ui.moreSection.themeToggleButtonMore, ui.themeToggleButtonDropdown];
    themeToggleButtons.forEach(button => {
        if(button) button.addEventListener('click', () => { applyTheme(document.body.classList.contains('light-theme') ? 'dark' : 'light'); });
    });

    function stopAllAudioAndRecognition(exceptCurrentRecognition = false) {
        speechSynthesis.cancel();
        if (ui.aiAudioPlayer && !ui.aiAudioPlayer.paused) { ui.aiAudioPlayer.pause(); ui.aiAudioPlayer.src = ""; }
        if (isVocarooPlayingIntent && ui.vocarooPlayer) {
            ui.vocarooPlayer.src = `https://vocaroo.com/embed/1l4oR62TDYEO?autoplay=0&_t=${Date.now()}`;
            isVocarooPlayingIntent = false;
            stopRobotTalking();
            if(ui.appExplainAudioButton?.querySelector('.tab-label')) ui.appExplainAudioButton.querySelector('.tab-label').textContent = 'Explain';
            if(ui.moreSection.playAppGuideMore) ui.moreSection.playAppGuideMore.innerHTML = '<i class="fas fa-play"></i> Play App Guide Audio';
            if(ui.playAppGuideAllFeatures) ui.playAppGuideAllFeatures.innerHTML = '<i class="fas fa-play"></i> Play App Guide';
        }
        if (isListeningForCommand && recognition && !exceptCurrentRecognition) {
            assistantContinuousListening = false;
            recognition.abort();
        } else if (!exceptCurrentRecognition) { assistantContinuousListening = false; }
        stopProcessingSound();
        if (activeCameraStream) stopActiveCamera();
    }
    
    function activateTab(tabId,subpageId=null,focusQuery=null){
        handleFirstInteraction();
        stopAllAudioAndRecognition();
        ui.tabButtons.forEach(b=>{b.classList.remove('active');b.setAttribute('aria-selected','false');});
        ui.tabContents.forEach(c=>c.classList.remove('active'));
        
        let targetBtn = ui.tabButtons.find(b => b.dataset.tab === tabId) || ui.tabButtons.find(b => b.dataset.tab === 'allFeaturesListContent');
        if(targetBtn){ targetBtn.classList.add('active'); targetBtn.setAttribute('aria-selected','true');}

        const targetContent=document.getElementById(tabId);
        if(targetContent) targetContent.classList.add('active');
        else { console.log(`Target content for tabId '${tabId}' not found.`); ui.tabContents[0].classList.add('active'); return; }
        
        const pageTitles = { homeContent:"Home", allFeaturesListContent:"All Features", assistantContent: "AI Assistant", textToAudioContent:"Text-to-Audio", translationContent:"Translator", photoReaderContent:"Image to Text Reader", pdfReaderContent:"PDF Reader", textToImageContent:"Image Generator", cashReaderContent:"Cash Reader", objectIdentifierContent:"Object ID", documentScannerContent:"Doc Scanner", locationContent:"Location Hub", navigationContent: "Navigation", aroundMeContent: "Around Me", travelModeContent: "Travel Mode", transitHubContent: "Transit Hub", newsContent:"News Updates", textToPdfContent:"Text to PDF", htmlToPdfToolContent: "HTML-to-PDF", qrCodeGeneratorToolContent: "QR Code Gen", slaCalculatorToolContent: "SLA Calculator", ipInfoToolContent: "IP Info", jokeContent: "Joke Teller", codeTesterToolContent: "Code Tester", calculatorContent: "Calculator", quotationsContent: "Quotations", moreContent:"More Options"};
        const subPageTitles = { settingsPage: "Settings", myLibraryPage: "My Library", userGuidePage: "User Guide", privacyPolicyPage: "Privacy Policy", contactDetailsPage: "Contact & About"};
        
        const headerTitle = subPageTitles[subpageId] || pageTitles[tabId] || 'Home';
        document.querySelector('.app-header .title-group').textContent = 'THIRD EYE' + (headerTitle === 'Home' ? '' : ` - ${headerTitle}`);
        
        if(tabId==='moreContent')showMoreSubpage(subpageId||'moreMainPage');
        else{ ui.moreSection.mainPage.style.display='block'; ui.moreSection.subpages.forEach(s=>s.style.display='none'); }
        
        if(tabId === 'locationContent') { 
            if(!leafletMap) initializeMap();
            else { setTimeout(() => leafletMap.invalidateSize(), 100); }
        }
        if(tabId === 'moreContent' && subpageId === 'myLibraryPage') { renderLibrary(); }

        let elementToFocus = targetContent.querySelector(focusQuery || '.back-button,h1,button:not(:disabled):not([style*="visibility:hidden"]),input,textarea,select');
        if(!elementToFocus) elementToFocus = targetBtn || targetContent;
        setTimeout(()=>elementToFocus.focus(), 150);
        window.scrollTo(0,0);
    }

    function showMoreSubpage(subpageId){
        const mainPage = ui.moreSection.mainPage;
        const targetSubpage = document.getElementById(subpageId);

        mainPage.style.display = 'none';
        ui.moreSection.subpages.forEach(s => s.style.display = 'none');
        
        if (targetSubpage) {
            targetSubpage.style.display = 'block';
            if (subpageId === 'myLibraryPage') renderLibrary();
            const subpageTitle = targetSubpage.querySelector('h3')?.textContent || 'More';
            document.querySelector('.app-header .title-group').textContent = `THIRD EYE - ${subpageTitle}`;
            setTimeout(() => (targetSubpage.querySelector('h3,a,button:not([disabled])') || targetSubpage).focus(), 100);
        } else {
            mainPage.style.display = 'block';
            document.querySelector('.app-header .title-group').textContent = `THIRD EYE - More Options`;
            setTimeout(() => (mainPage.querySelector('h1,button') || mainPage).focus(), 100);
        }
    }
    ui.moreSection.settingsButton.addEventListener('click', () => showMoreSubpage('settingsPage'));
    ui.moreSection.myLibraryButton.addEventListener('click', () => showMoreSubpage('myLibraryPage'));
    ui.moreSection.userGuideButton.addEventListener('click', () => showMoreSubpage('userGuidePage'));
    ui.moreSection.privacyButton.addEventListener('click', () => showMoreSubpage('privacyPolicyPage'));
    ui.moreSection.contactButton.addEventListener('click', () => showMoreSubpage('contactDetailsPage'));
    ui.moreSection.backLinks.forEach(l=>l.addEventListener('click',(e)=>{ e.preventDefault(); showMoreSubpage(l.dataset.targetMain);}));
    
    if(ui.topRightMoreButton) {
        ui.topRightMoreButton.addEventListener('click', (e) => { e.stopPropagation(); ui.topRightDropdownMenu.classList.toggle('active'); ui.topRightMoreButton.setAttribute('aria-expanded', ui.topRightDropdownMenu.classList.contains('active')); });
        document.addEventListener('click', (e) => { if (ui.topRightDropdownMenu.classList.contains('active') && !ui.topRightDropdownMenu.contains(e.target) && !ui.topRightMoreButton.contains(e.target)) { ui.topRightDropdownMenu.classList.remove('active'); ui.topRightMoreButton.setAttribute('aria-expanded', 'false'); }});
        
        const setupDropdownLink = (button, tab, subpage = null) => { if (button) button.addEventListener('click', () => { activateTab(tab, subpage); ui.topRightDropdownMenu.classList.remove('active'); ui.topRightMoreButton.setAttribute('aria-expanded', 'false'); }); };
        setupDropdownLink(ui.dropdownSettingsButton, 'moreContent', 'settingsPage');
        setupDropdownLink(ui.dropdownLibraryButton, 'moreContent', 'myLibraryPage');
        setupDropdownLink(ui.dropdownPrivacyButton, 'moreContent', 'privacyPolicyPage');
        setupDropdownLink(ui.dropdownContactButton, 'moreContent', 'contactDetailsPage');
        setupDropdownLink(ui.dropdownUserGuideButton, 'moreContent', 'userGuidePage');
    }

    ui.moreSection.playAppGuideMore.addEventListener('click', () => tryPlayVocaroo(!isVocarooPlayingIntent));
    ui.playAppGuideAllFeatures.addEventListener('click', () => tryPlayVocaroo(!isVocarooPlayingIntent));
    
    ui.pageBackButtons.forEach(button => button.addEventListener('click', () => activateTab(button.dataset.targetTab || 'allFeaturesListContent')));
    ui.tabButtons.forEach(b=>b.addEventListener('click',()=>activateTab(b.dataset.tab)));
    
    // --- Universal Navigation Handler ---
    // This handles all buttons that are meant to switch tabs, except for the main bottom tab bar.
    // It makes the app more modular by simply requiring a 'data-target-tab' attribute on any button
    // that needs to navigate, like those on the Home, All Features, and Location Hub pages.
    document.body.addEventListener('click', (e) => {
        const navButton = e.target.closest('button[data-target-tab]');
        
        // Ensure the button exists and is not part of the main tab bar (which has its own handler)
        if (navButton && !navButton.closest('.tab-bar')) {
            const targetTab = navButton.dataset.targetTab;
            if (targetTab) {
                activateTab(targetTab);
            }
        }
    });

    function tryPlayVocaroo(forceRestart = false){
        if(!ui.vocarooPlayer)return;
        handleFirstInteraction(); stopAllAudioAndRecognition(); 
        const vocarooBase = "https://vocaroo.com/embed/1l4oR62TDYEO";
        const buttonsToUpdate = [
            { el: ui.appExplainAudioButton?.querySelector('.tab-label'), text: 'Explain', stopText: 'Stop Guide', type: 'label'},
            { el: ui.moreSection.playAppGuideMore, text: 'Play App Guide Audio', stopText: 'Stop App Guide Audio', playIcon: 'fas fa-play', stopIcon: 'fas fa-stop', type: 'button' },
            { el: ui.playAppGuideAllFeatures, text: 'Play App Guide', stopText: 'Stop App Guide', playIcon: 'fas fa-play', stopIcon: 'fas fa-stop', type: 'button' }
        ];

        if(forceRestart || !isVocarooPlayingIntent){
            ui.vocarooPlayer.src = `${vocarooBase}?autoplay=1&_t=${Date.now()}`; isVocarooPlayingIntent = true; startRobotTalking();
            buttonsToUpdate.forEach(item => { if(item.el) item.el.innerHTML = item.type === 'label' ? item.stopText : `<i class="${item.stopIcon}"></i> ${item.stopText}`; });
        } else {
            ui.vocarooPlayer.src = `${vocarooBase}?autoplay=0&_t=${Date.now()}`; isVocarooPlayingIntent = false; stopRobotTalking();
            buttonsToUpdate.forEach(item => { if(item.el) item.el.innerHTML = item.type === 'label' ? item.text : `<i class="${item.playIcon}"></i> ${item.text}`; });
        }
    }
    ui.appExplainAudioButton.addEventListener('click',()=>tryPlayVocaroo(!isVocarooPlayingIntent));
    
    // --- Voice Systems ---
    async function speakWithAI(text, voice, onEndCallback) {
        handleFirstInteraction();
        stopAllAudioAndRecognition();
        
        if (!text) { 
            if (onEndCallback) onEndCallback();
            speakSystemMessage("No text to read."); 
            return; 
        }
        
        try {
            const requestBody = {
                service: "tts",
                input: text,
                voice: voice
            };

            const response = await fetch(BACKEND_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ error: "Unknown audio generation error." }));
                log(`Backend TTS Error: Status ${response.status}, Message: ${errorData.error}`);
                throw new Error(errorData.error || "The AI processor encountered a critical error while generating audio.");
            }
            
            const audioBlob = await response.blob();
            if (audioBlob.size === 0) {
                throw new Error("Received empty audio file from processor.");
            }
            const audioUrl = URL.createObjectURL(audioBlob);
            const player = ui.aiAudioPlayer;
            player.src = audioUrl; player.play();
            
            player.onplaying = startRobotTalking;
            player.onended = () => {
                stopRobotTalking(); 
                URL.revokeObjectURL(audioUrl);
                if (onEndCallback) onEndCallback();
            };
            player.onerror = (e) => { 
                log(`Audio Playback Error: ${e}`);
                throw new Error("Audio playback failed.");
            };

        } catch (e) {
            log(`AI TTS Error: ${e.message}`);
             // FIX: This error message is now more specific to the CORS/spin-down issue.
            if (e instanceof TypeError) {
                 speakSystemMessage("Connection to audio server failed. The free server may be spinning up (takes ~50s). Please wait a minute and try again.");
            } else {
                 speakSystemMessage(e.message || "Sorry, I couldn't generate the audio for that.");
            }
            if (onEndCallback) onEndCallback();
        }
    }


    // For standard, fast system feedback
    function speakSystemMessage(text, onEnd) {
        handleFirstInteraction();
        if (ui.aiAudioPlayer && !ui.aiAudioPlayer.paused) { ui.aiAudioPlayer.pause(); ui.aiAudioPlayer.src = ""; }
        speechSynthesis.cancel();
        if (!speechSynthesis || !text || String(text).trim() === '') { if (onEnd) onEnd(); return; }
        
        const utterance = new SpeechSynthesisUtterance(text);
        const globalVoiceName = localStorage.getItem('globalVoiceName');
        const voiceToUse = globalVoiceName ? systemVoices.find(v => v.name === globalVoiceName) : (systemVoices.find(v => v.default && v.lang.startsWith('en')) || systemVoices[0]);
        if (voiceToUse) utterance.voice = voiceToUse;

        utterance.onstart = startRobotTalking;
        utterance.onend = () => { stopRobotTalking(); if (onEnd) onEnd(); };
        utterance.onerror = e => { log(`System TTS Err: ${e.error}`); stopRobotTalking(); };
        speechSynthesis.speak(utterance);
    }


    function startRobotTalking() { if(ui.robotMouth) ui.robotMouth.style.animation = 'mouthMove 0.5s infinite alternate';}
    function stopRobotTalking() { if(ui.robotMouth) ui.robotMouth.style.animation = 'none'; }


    function populateVoiceList(){
        const select = ui.moreSection.globalVoiceSelect; if(!select) return;
        if(!speechSynthesis) { select.innerHTML = '<option disabled>No voices found.</option>'; return; }
        
        const updateList = () => {
            systemVoices = speechSynthesis.getVoices();
            if(systemVoices.length === 0) return;
            systemVoices.sort((a,b)=>a.lang.localeCompare(b.lang)||a.name.localeCompare(b.name));
            const savedGlobalVoice = localStorage.getItem('globalVoiceName');
            select.innerHTML = '';
            systemVoices.forEach(v => {
                const option = new Option(`${v.name} (${v.lang})${v.default ? ' [Default]' : ''}`, v.name);
                if (savedGlobalVoice === v.name) option.selected = true;
                select.add(option);
            });
        };
        if(speechSynthesis.onvoiceschanged !== undefined) speechSynthesis.onvoiceschanged = updateList;
        updateList();
    }
    
    ui.moreSection.globalVoiceSelect.addEventListener('change', (e) => {
        localStorage.setItem('globalVoiceName', e.target.value);
        speakSystemMessage(`Default system voice set to ${e.target.value.split('(')[0]}.`);
    });

    ui.ttsTool.speakButton.addEventListener('click',()=>{
        const toolUI = ui.ttsTool;
        const text = toolUI.textToSpeakInput.value.trim();
        const voice = toolUI.aiVoiceSelect.value;
        if (!text) { speakSystemMessage("Please enter text to read."); return; }
        toolUI.speakButton.disabled = true;
        toolUI.stopButton.disabled = false;
        toolUI.statusMessage.textContent = 'Generating audio...';
        
        const speakTask = async () => {
            await speakWithAI(text, voice, () => {
                toolUI.speakButton.disabled = false;
                toolUI.stopButton.disabled = true;
                toolUI.statusMessage.textContent = 'Finished.';
            });
        };
        manageProcessingIndicator(speakTask);
    });

    ui.ttsTool.stopButton.addEventListener('click',()=>{
        if(ui.aiAudioPlayer) { ui.aiAudioPlayer.pause(); ui.aiAudioPlayer.currentTime = 0; }
        ui.ttsTool.speakButton.disabled = false; ui.ttsTool.stopButton.disabled = true;
        ui.ttsTool.statusMessage.textContent = 'Stopped.'; stopRobotTalking();
    });
    
    ui.ttsTool.downloadAudioButton.addEventListener('click', () => {
        const downloadTask = async () => {
            const text = ui.ttsTool.textToSpeakInput.value.trim();
            const voice = ui.ttsTool.aiVoiceSelect.value;
            if (!text) { speakSystemMessage('No text to download.'); return; }
            ui.ttsTool.statusMessage.textContent = 'Preparing download...';
            try {
                const requestBody = {
                    service: "tts",
                    input: text,
                    voice: voice
                };
                const response = await fetch(BACKEND_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                if (!response.ok) throw new Error("API request failed");
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `TEYE_audio.mp3`; a.click(); a.remove();
                URL.revokeObjectURL(url);
                ui.ttsTool.statusMessage.textContent = 'Download started.';
                speakSystemMessage('Audio download started.');
            } catch (e) { 
                log(`TTS Download Err: ${e.message}`); 
                const errorMessage = e instanceof TypeError ? "Connection to audio server failed. The server may be waking up." : 'Download failed.';
                ui.ttsTool.statusMessage.textContent = errorMessage;
                speakSystemMessage(errorMessage); 
            }
        };
        manageProcessingIndicator(downloadTask);
    });

    ui.ttsTool.copyTextButton.addEventListener('click', () => { const txt = ui.ttsTool.textToSpeakInput.value; if(txt.trim()){ navigator.clipboard.writeText(txt).then(()=> speakSystemMessage('Text copied.')); }});
    if(navigator.share) {
        ui.ttsTool.shareTextButton.addEventListener('click',async()=>{const txt=ui.ttsTool.textToSpeakInput.value;if(txt.trim()){try{await navigator.share({title:'Text from TEYE',text:txt});}catch(e){speakSystemMessage('Could not share.');log('Share err: '+e);}}else{speakSystemMessage('No text to share.');}});
    } else { ui.ttsTool.shareTextButton.style.display='none'; }
    
    async function activateAssistantPageAndListen(triggeredByFloatButton = true){
        handleFirstInteraction();
        if (SpeechRecognition) {
            const micPermissionGranted = await requestPermission('microphone');
            if (!micPermissionGranted) return;
        }
        if (triggeredByFloatButton) activateTab('assistantContent', null, '#assistantCommandInput');
        stopAllAudioAndRecognition(true);
        setTimeout(() => { assistantContinuousListening = true; activateVoiceInput(); }, 150);
    }
    ui.assistantTool.floatingButton.addEventListener('click', () => activateAssistantPageAndListen(true));
    
    let tapTimeout,tapCount=0;
    document.body.addEventListener('click',(e)=>{
        const isInteractiveElement = e.target.closest('button, a, input, select, textarea, [role="button"], [role="menuitem"], .file-input-label, #initialPlayOverlay, #permissionsOverlay, #soundPromptOverlay, .leaflet-container');
        if(isInteractiveElement){
            handleFirstInteraction();
            tapCount=0; if(tapTimeout) clearTimeout(tapTimeout); return;
        }

        handleFirstInteraction();
        tapCount++; if(tapTimeout)clearTimeout(tapTimeout);
        tapTimeout=setTimeout(()=>{ if(tapCount===2 && SpeechRecognition){ log("Double tap detected."); activateAssistantPageAndListen(false); } tapCount=0; },350);
    });
    
    if(SpeechRecognition){
        recognition=new SpeechRecognition(); recognition.continuous=false; recognition.lang='en-US'; recognition.interimResults=false;
        recognition.onstart=()=>{ isListeningForCommand=true; if(ui.assistantTool.listeningIndicator) { ui.assistantTool.listeningIndicator.textContent=assistantContinuousListening?"Listening... (Say 'stop listening')":"Listening..."; ui.assistantTool.listeningIndicator.style.display='flex'; } if(ui.assistantTool.floatingButton) { ui.assistantTool.floatingButton.innerHTML='<i class="fas fa-microphone-slash"></i>'; } startRobotTalking(); };
        recognition.onresult=(e)=>{ const transcript=e.results[0][0].transcript; log(`Speech-to-Text: ${transcript}`); manageProcessingIndicator(() => processAssistantCommand(transcript)); };
        recognition.onend=()=>{
            isListeningForCommand=false; stopRobotTalking();
            if (!assistantContinuousListening) { if(ui.assistantTool.listeningIndicator) ui.assistantTool.listeningIndicator.style.display='none'; if(ui.assistantTool.floatingButton) { ui.assistantTool.floatingButton.innerHTML='🤖'; } }
        };
        recognition.onerror = async(e)=>{
            isListeningForCommand = false; stopRobotTalking(); 
            log(`STT Error: ${e.error}. Message: ${e.message}`);
            
            if(e.error === 'no-speech' && assistantContinuousListening) {
                speakSystemMessage("I didn't hear anything. Still listening.", () => activateVoiceInput(true));
                return; 
            }

            assistantContinuousListening = false;
            let message = `Voice recognition error: ${e.error}.`;
            if (e.error === 'not-allowed') message = "Microphone access was denied.";
            if (e.error !== 'aborted') speakSystemMessage(message);
        };
    } else { log("SpeechRecognition API not available."); ui.assistantTool.floatingButton.disabled=true; ui.assistantTool.floatingButton.title = "Voice commands not supported."; }

    async function activateVoiceInput(isContinuation=false){
        if(!recognition){ speakSystemMessage("Voice commands not available on this browser."); return; }
        
        const micPermissionGranted = await requestPermission('microphone');
        if (!micPermissionGranted) { assistantContinuousListening = false; return; }
        
        if(isListeningForCommand){ recognition.stop(); }
        else{ stopAllAudioAndRecognition(true); if(!isContinuation) assistantContinuousListening = true; try{ recognition.start(); } catch(e){ log(`STT Start Err: ${e.message}`); assistantContinuousListening=false; speakSystemMessage(`Voice input error.`); } }
    }
    
    async function processAssistantCommand(command) {
        const cmd = String(command).trim().toLowerCase(); 
        ui.assistantTool.commandInput.value = command;
        ui.assistantTool.responseArea.textContent = `You said: "${command}"\nProcessing...`;
        log(`Assistant Command: "${cmd}"`);
    
        if (cmd.includes("stop listening") || cmd.includes("goodbye")) {
            assistantContinuousListening = false;
            if (isListeningForCommand && recognition) recognition.stop();
            const responseText = "Okay, I've stopped listening. Goodbye!";
            ui.assistantTool.responseArea.textContent = responseText;
            speakSystemMessage(responseText);
            return;
        }

        ui.assistantTool.responseArea.textContent = "Accessing knowledge base...";
        try {
            const featureDescriptions = Object.entries(appInfo.guides)
                .map(([key, value]) => `- ${key.replace(/([A-Z])/g, ' $1').trim()}: ${value}`)
                .join('\n');
            
            const systemPrompt = `You are THIRD EYE, a helpful, friendly, and concise AI assistant inside a web app. Your creator is a developer named Teja.
If the user's request matches one of the commands below, you MUST respond with ONLY the command in this format: "COMMAND::[command_name]". Do not add any other text.
Available commands: "go_to_home", "go_to_all_features", "go_to_text_to_audio", "go_to_translator", "go_to_image_to_text", "go_to_pdf_reader", "go_to_image_generator", "go_to_cash_reader", "go_to_object_identifier", "go_to_document_scanner", "go_to_location_hub", "go_to_news", "go_to_calculator", "tell_a_joke", "get_a_quote", "go_to_my_library", "go_to_settings", "show_my_location", "change_theme".
For any other request (e.g., questions, help), provide a direct, conversational answer using this app info for context:
${featureDescriptions}`;

            const fullPrompt = `${systemPrompt}\n\nUser said: "${command}"`;
            let reply = await queryAI(fullPrompt);

            if (reply.startsWith("COMMAND::")) {
                const commandName = reply.split("::")[1].trim();
                const navMap = {
                    go_to_home: { tab: 'homeContent', msg: "Navigating to Home." },
                    go_to_all_features: { tab: 'allFeaturesListContent', msg: "Showing all features." },
                    go_to_text_to_audio: { tab: 'textToAudioContent', msg: "Opening Text to Audio." },
                    go_to_translator: { tab: 'translationContent', msg: "Opening Translator." },
                    go_to_image_to_text: { tab: 'photoReaderContent', msg: "Opening Image to Text Reader." },
                    go_to_pdf_reader: { tab: 'pdfReaderContent', msg: "Opening PDF Reader." },
                    go_to_image_generator: { tab: 'textToImageContent', msg: "Opening Image Generator." },
                    go_to_cash_reader: { tab: 'cashReaderContent', msg: "Opening Cash Reader." },
                    go_to_object_identifier: { tab: 'objectIdentifierContent', msg: "Opening Object Identifier." },
                    go_to_document_scanner: { tab: 'documentScannerContent', msg: "Opening Document Scanner." },
                    go_to_location_hub: { tab: 'locationContent', msg: "Opening Location Hub." },
                    go_to_news: { tab: 'newsContent', msg: "Opening News Updates." },
                    go_to_calculator: { tab: 'calculatorContent', msg: "Opening Calculator." },
                    go_to_my_library: { tab: 'moreContent', subpage: 'myLibraryPage', msg: "Opening My Library." },
                    go_to_settings: { tab: 'moreContent', subpage: 'settingsPage', msg: "Opening Settings." },
                    tell_a_joke: { tab: 'jokeContent', action: () => ui.jokeTool.fetchJokeButton.click(), msg: "One moment..." },
                    get_a_quote: { tab: 'quotationsContent', action: () => ui.quotationsTool.fetchButton.click(), msg: "Finding a quote..." },
                    show_my_location: { tab: 'locationContent', action: () => ui.locationTool.getLocationButton.click(), msg: "Fetching your location..." },
                    change_theme: { action: () => applyTheme(document.body.classList.contains('light-theme')?'dark':'light'), getMsg: () => `Switched to ${document.body.classList.contains('light-theme')?'Light':'Dark'} theme.` }
                };
                if(navMap[commandName]) {
                    const nav = navMap[commandName];
                    if (nav.action) nav.action();
                    if (nav.tab) activateTab(nav.tab, nav.subpage || null);
                    reply = nav.getMsg ? nav.getMsg() : nav.msg;
                } else {
                    reply = "I understood a command, but couldn't execute it.";
                }
            }
            
            ui.assistantTool.responseArea.textContent = reply;
            speakWithAI(reply, 'nova', () => { if (assistantContinuousListening) { activateVoiceInput(true); } });

        } catch (error) { 
            log(`AI Assistant Query Error: ${error.message}`);
            ui.assistantTool.responseArea.textContent = error.message;
            speakSystemMessage(error.message, () => { if (assistantContinuousListening) { activateVoiceInput(true); } }); 
        }
    }
    ui.assistantTool.submitCommandButton.addEventListener('click',()=>{if(ui.assistantTool.commandInput.value.trim()) manageProcessingIndicator(() => processAssistantCommand(ui.assistantTool.commandInput.value));});
    ui.assistantTool.commandInput.addEventListener('keypress',(e)=>{if(e.key==='Enter' && !e.shiftKey){e.preventDefault();if(ui.assistantTool.commandInput.value.trim()) manageProcessingIndicator(() => processAssistantCommand(ui.assistantTool.commandInput.value));}});
    
    function populateLanguageDropdowns(){ const f=ui.translatorTool.fromLangSelect,t=ui.translatorTool.toLangSelect; f.innerHTML = ''; t.innerHTML = ''; for(const c in TRANSLATION_LANGUAGES){f.add(new Option(TRANSLATION_LANGUAGES[c],c));if(c!=='auto')t.add(new Option(TRANSLATION_LANGUAGES[c],c));}f.value='auto';t.value='en';}
    
    async function translateText(){
        const txt=ui.translatorTool.inputTextArea.value.trim(); 
        const fromLangName = TRANSLATION_LANGUAGES[ui.translatorTool.fromLangSelect.value] || 'auto';
        const toLangName = TRANSLATION_LANGUAGES[ui.translatorTool.toLangSelect.value] || 'English';

        if(!txt){speakSystemMessage("Enter text to translate.");return;}
        ui.translatorTool.statusMessage.textContent = 'Translating...';
        speakSystemMessage("Translating...");

        try{
            const prompt = `Translate the following text from ${fromLangName} to ${toLangName}. Provide only the translated text, with no additional commentary, labels, or quotation marks. The text to translate is: "${txt}"`;
            const translatedText = await queryAI(prompt);
            
            if(translatedText){
                ui.translatorTool.outputTextArea.value = translatedText; 
                ui.translatorTool.readButton.disabled = false; 
                ui.translatorTool.copyButton.disabled = false;
                ui.translatorTool.statusMessage.textContent = 'Translation complete.';
                speakSystemMessage(`Translated text is ready.`);
            }else{ throw new Error("Translation failed to return text."); }
        }catch(e){ 
            log(`Translate Err: ${e.message}`);
            ui.translatorTool.statusMessage.textContent = e.message;
            speakSystemMessage(e.message);
        }
    }
    ui.translatorTool.translateButton.addEventListener('click',() => manageProcessingIndicator(translateText));
    ui.translatorTool.swapButton.addEventListener('click',()=>{const fV=ui.translatorTool.fromLangSelect.value,tV=ui.translatorTool.toLangSelect.value;if(fV!=='auto'){ui.translatorTool.fromLangSelect.value=tV;ui.translatorTool.toLangSelect.value=fV;}});
    ui.translatorTool.readButton.addEventListener('click',()=>{const t=ui.translatorTool.outputTextArea.value;if(t.trim())speakSystemMessage(t);});
    ui.translatorTool.copyButton.addEventListener('click',()=>{const t=ui.translatorTool.outputTextArea.value;if(t.trim()){navigator.clipboard.writeText(t).then(()=>speakSystemMessage("Copied."));}});
    
    async function processPhotoWithAI(imageDataUrl) {
        if (!imageDataUrl) return;
        const toolUI = ui.photoReaderTool;
        
        toolUI.statusMessage.textContent = "Extracting text with AI Vision...";
        toolUI.extractedTextArea.value = "";
        [toolUI.readButton, toolUI.copyButton, toolUI.shareButton, toolUI.stopButton].forEach(btn => btn.disabled = true);

        speakSystemMessage("Analyzing image for text...");

        try {
            const prompt = "Extract text from this image. Provide ONLY the raw text content.";
            const text = await queryAI(prompt, true, imageDataUrl);
            
            toolUI.extractedTextArea.value = text;
            toolUI.statusMessage.textContent = "Text extracted successfully.";
            if (text) {
                toolUI.readButton.disabled = false;
                toolUI.copyButton.disabled = false;
                if(navigator.share) toolUI.shareButton.disabled = false;
            }
            speakSystemMessage(text ? "Text extracted." : "No text found.");
        } catch (err) {
            log(`Vision OCR Err: ${err.message}`);
            toolUI.statusMessage.textContent = err.message;
            speakSystemMessage("Sorry, I could not extract text from that image.");
        }
    }
    
    ui.photoReaderTool.readButton.addEventListener('click', () => {
        const text = ui.photoReaderTool.extractedTextArea.value;
        if (text) {
            ui.photoReaderTool.stopButton.disabled = false;
            speakSystemMessage(text, () => {
                ui.photoReaderTool.stopButton.disabled = true;
            });
        }
    });
    ui.photoReaderTool.copyButton.addEventListener('click', () => { const text = ui.photoReaderTool.extractedTextArea.value; if (text) { navigator.clipboard.writeText(text).then(() => speakSystemMessage('Text copied.')); }});
    ui.photoReaderTool.stopButton.addEventListener('click', () => {
        speechSynthesis.cancel();
        stopRobotTalking();
        ui.photoReaderTool.stopButton.disabled = true;
    });
    if (navigator.share) {
        ui.photoReaderTool.shareButton.addEventListener('click', () => { const text = ui.photoReaderTool.extractedTextArea.value; if (text) { navigator.share({ title: 'Text from TEYE', text }); } });
    } else {
        ui.photoReaderTool.shareButton.style.display = 'none';
    }

    async function getPdfPageText(pageIndex) {
        if (pdfPagesText[pageIndex] !== undefined) return pdfPagesText[pageIndex];
        if (!currentPdfDoc) return "";

        try {
            const page = await currentPdfDoc.getPage(pageIndex + 1);
            const textContent = await page.getTextContent();
            const text = textContent.items.map(item => item.str).join(" ").trim();
            pdfPagesText[pageIndex] = text;
            return text;
        } catch (e) {
            log(`Error getting text for page ${pageIndex + 1}: ${e.message}`);
            pdfPagesText[pageIndex] = "";
            return "";
        }
    }

    async function updatePdfPageDisplay() {
        const tool = ui.pdfReaderTool;
        if (!currentPdfDoc) {
            tool.extractedTextArea.value = "";
            tool.navigationControls.style.display = 'none';
            [tool.readPageButton, tool.analyzeButton, tool.copyPageButton, tool.downloadAllTextButton, tool.downloadAllAudioButton, tool.shareAllTextButton].forEach(b => b.disabled = true);
            return;
        }
        tool.statusMessage.textContent = `Loading page ${currentPdfPageIndex + 1}...`;
        const text = await getPdfPageText(currentPdfPageIndex);
        tool.extractedTextArea.value = text || "No text found on this page.";
        tool.pageIndicator.textContent = `Page ${currentPdfPageIndex + 1} of ${currentPdfDoc.numPages}`;
        tool.prevPageButton.disabled = currentPdfPageIndex === 0;
        tool.nextPageButton.disabled = currentPdfPageIndex >= currentPdfDoc.numPages - 1;
        
        const hasText = !!text;
        tool.readPageButton.disabled = !hasText;
        tool.analyzeButton.disabled = !hasText;
        tool.copyPageButton.disabled = !hasText;
        tool.statusMessage.textContent = 'Page loaded.';
    }
    
    async function processPdfFile(file) {
        if (!file) return;
        if (typeof pdfjsLib === 'undefined') { speakSystemMessage("PDF reader not ready."); return; }
        speakSystemMessage("Loading PDF...");
        const tool = ui.pdfReaderTool;
        currentPdfDoc = null; pdfPagesText = []; currentPdfPageIndex = 0;
        updatePdfPageDisplay();
        
        const fileReader = new FileReader();
        fileReader.onload = async (ev) => {
            tool.statusMessage.textContent = "Processing PDF structure...";
            await manageProcessingIndicator(async () => {
                try {
                    const typedarray = new Uint8Array(ev.target.result);
                    const doc = await pdfjsLib.getDocument({ data: typedarray }).promise;
                    currentPdfDoc = doc;
                    pdfPagesText = new Array(doc.numPages);
                    
                    tool.navigationControls.style.display = 'flex';
                    [tool.downloadAllTextButton, tool.downloadAllAudioButton, tool.shareAllTextButton].forEach(b => b.disabled = false);

                    await updatePdfPageDisplay();
                    speakSystemMessage(`PDF loaded with ${doc.numPages} pages.`);
                } catch (err) { log(`PDF Err: ${err}`); speakSystemMessage("PDF processing failed."); } 
            });
        };
        fileReader.readAsArrayBuffer(file);
    }

    async function extractAllPdfText() {
        if (!currentPdfDoc) return "";
        let allText = [];
        ui.pdfReaderTool.statusMessage.textContent = 'Processing all pages... 0%';
        for (let i = 0; i < currentPdfDoc.numPages; i++) {
            const pageText = await getPdfPageText(i);
            allText.push(pageText);
            ui.pdfReaderTool.statusMessage.textContent = `Processing all pages... ${Math.round((i+1)/currentPdfDoc.numPages * 100)}%`;
        }
        ui.pdfReaderTool.statusMessage.textContent = 'All pages processed.';
        return allText.join('\n\n--- Page Break ---\n\n');
    }
    
    ui.pdfReaderTool.fileInput.addEventListener('change', async(e) => { await processPdfFile(e.target.files[0]); e.target.value = null; });
    ui.pdfReaderTool.prevPageButton.addEventListener('click', async () => { if(currentPdfPageIndex>0){currentPdfPageIndex--; await updatePdfPageDisplay(); speakSystemMessage(`Page ${currentPdfPageIndex+1}.`);}});
    ui.pdfReaderTool.nextPageButton.addEventListener('click', async () => { if(currentPdfDoc && currentPdfPageIndex<currentPdfDoc.numPages-1){currentPdfPageIndex++; await updatePdfPageDisplay(); speakSystemMessage(`Page ${currentPdfPageIndex+1}.`);}});
    ui.pdfReaderTool.readPageButton.addEventListener('click',()=>{const t=ui.pdfReaderTool.extractedTextArea.value;if(t?.trim())speakSystemMessage(t);});
    ui.pdfReaderTool.copyPageButton.addEventListener('click',()=>{const t=ui.pdfReaderTool.extractedTextArea.value;if(t?.trim()){navigator.clipboard.writeText(t).then(() => speakSystemMessage("Page text copied."));}});
    
    ui.pdfReaderTool.analyzeButton.addEventListener('click', () => {
        const pageText = ui.pdfReaderTool.extractedTextArea.value;
        if (!pageText.trim()) { speakSystemMessage("No text on this page to analyze."); return; }
        manageProcessingIndicator(async () => {
            speakSystemMessage("Analyzing page content with AI...");
            try {
                const prompt = `Summarize the following text from a PDF page and list its key points clearly. Text:\n\n"${pageText}"`;
                const analysis = await queryAI(prompt);
                alert("AI Analysis:\n\n" + analysis); 
                speakSystemMessage("Here is the analysis: " + analysis);
            } catch (e) {
                log(`PDF Analysis Error: ${e.message}`);
                speakSystemMessage(e.message);
            }
        });
    });

    ui.pdfReaderTool.downloadAllTextButton.addEventListener('click', () => {
        manageProcessingIndicator(async () => {
            const allText = await extractAllPdfText();
            if (allText.trim()) {
                const blob = new Blob([allText], {type: 'text/plain;charset=utf-8'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = 'TEYE_pdf_full_text.txt';
                a.click(); a.remove(); URL.revokeObjectURL(url);
                speakSystemMessage("Full text download started.");
            } else { speakSystemMessage("No text to download."); }
        });
    });

    ui.pdfReaderTool.downloadAllAudioButton.addEventListener('click', () => {
        manageProcessingIndicator(async () => {
            const allText = await extractAllPdfText();
            if (allText.trim()) {
                ui.pdfReaderTool.statusMessage.textContent = 'Generating full audio... this may take time.';
                speakSystemMessage("Generating audio for the entire document. This may take a while.");
                try {
                    const requestBody = {
                        service: "tts",
                        input: allText.substring(0, 4096), // TTS has limits
                        voice: 'fable'
                    };
                    const response = await fetch(BACKEND_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody)
                    });
                    if (!response.ok) throw new Error("API request failed");
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a'); a.href = url; a.download = 'TEYE_pdf_full_audio.mp3'; a.click(); a.remove();
                    URL.revokeObjectURL(url);
                    ui.pdfReaderTool.statusMessage.textContent = 'Audio download started.';
                    speakSystemMessage("Full audio download started.");
                } catch (e) {
                    log(`PDF Audio Download Err: ${e.message}`);
                    const errorMessage = e instanceof TypeError ? "Connection to audio server failed." : 'Audio download failed.';
                    ui.pdfReaderTool.statusMessage.textContent = errorMessage;
                    speakSystemMessage(errorMessage);
                }
            } else { speakSystemMessage("No text to convert to audio."); }
        });
    });

    ui.pdfReaderTool.shareAllTextButton.addEventListener('click', () => {
        if (!navigator.share) { speakSystemMessage("Sharing not supported on this browser."); return; }
        manageProcessingIndicator(async () => {
            const allText = await extractAllPdfText();
            if (allText.trim()) {
                try {
                    await navigator.share({ title: 'Text from PDF via TEYE', text: allText });
                } catch (e) { speakSystemMessage("Could not share text."); }
            } else { speakSystemMessage("No text to share."); }
        });
    });
    
    function generateImage(isRegenerate = false) {
        return new Promise((resolve, reject) => {
            const tool = ui.textToImageTool;
            const promptText = tool.promptInput.value.trim();
            if (!promptText) {
                const msg = "Please enter a prompt.";
                speakSystemMessage(msg);
                reject(new Error(msg));
                return;
            }

            speakSystemMessage(isRegenerate ? "Regenerating..." : "Generating image...");
            tool.statusMessage.textContent = 'Generating... This may take a moment.';
            tool.imageElement.style.display = 'none';
            tool.actionButtons.style.display = 'none';

            try {
                const encodedPrompt = encodeURIComponent(promptText);
                const seed = Math.floor(Math.random() * 100000);
                const imageUrl = `https://image.pollinations.ai/prompt/${encodedPrompt}?width=1024&height=1024&seed=${seed}&nologo=true`;

                log(`Constructed image URL: ${imageUrl}`);
                tool.imageElement.src = imageUrl;
                tool.imageElement.alt = `AI: ${promptText.substring(0, 50)}`;

                tool.imageElement.onload = () => {
                    tool.imageElement.style.display = 'block';
                    tool.actionButtons.style.display = 'flex';
                    tool.statusMessage.textContent = 'Image generated successfully.';
                    speakSystemMessage("Image generated.");
                    resolve();
                };

                tool.imageElement.onerror = () => {
                    const errorMsg = "Image service failed to load. It might be down or blocked.";
                    tool.statusMessage.textContent = errorMsg;
                    speakSystemMessage(errorMsg);
                    reject(new Error(errorMsg));
                };
            } catch (e) {
                log(`ImgGen Setup Err: ${e.message}`);
                tool.statusMessage.textContent = e.message;
                speakSystemMessage(e.message);
                reject(e);
            }
        });
    }

    ui.textToImageTool.generateButton.addEventListener('click',()=>manageProcessingIndicator(() => generateImage(false)));
    ui.textToImageTool.regenerateButton.addEventListener('click',()=>manageProcessingIndicator(() => generateImage(true)));
    ui.textToImageTool.downloadButton.addEventListener('click',()=>{ const a=document.createElement('a'); a.href=ui.textToImageTool.imageElement.src; a.download=`TEYE_image.png`; a.click(); a.remove(); });
    
    async function startCameraFor(tool) {
        const cameraPermissionGranted = await requestPermission('camera');
        if (!cameraPermissionGranted) return;
    
        if (activeCameraStream) stopActiveCamera();
    
        try {
            activeCameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            tool.cameraFeed.srcObject = activeCameraStream;
            tool.cameraContainer.style.display = 'block';
            tool.startCameraButton.innerHTML = '<i class="fas fa-stop-circle"></i> Stop Camera';
        } catch (e) {
            log(`Camera Start Err for ${tool}: ${e.message}`);
            speakSystemMessage("Could not start camera.");
            activeCameraStream = null;
        }
    }

    function stopActiveCamera() {
        if (activeCameraStream) {
            activeCameraStream.getTracks().forEach(track => track.stop());
            activeCameraStream = null;
        }
        [ui.cashReaderTool, ui.objectIdentifierTool, ui.documentScannerTool, ui.photoReaderTool].forEach(tool => {
            if(tool) {
                if(tool.cameraContainer) tool.cameraContainer.style.display = 'none';
                if(tool.cameraFeed) tool.cameraFeed.srcObject = null;
                if(tool.startCameraButton) tool.startCameraButton.innerHTML = '<i class="fas fa-camera"></i> Use Camera';
            }
        });
        log("Active camera stopped.");
    }
    
    const photoTool = ui.photoReaderTool;
    photoTool.startCameraButton.addEventListener('click', () => { if (activeCameraStream) { stopActiveCamera(); } else { startCameraFor(photoTool); } });
    photoTool.captureButton.addEventListener('click', () => {
        const video = photoTool.cameraFeed; const canvas = photoTool.cameraCanvas;
        if (video.videoWidth === 0) { speakSystemMessage("Camera not ready."); return; }
        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageDataUrl = canvas.toDataURL('image/jpeg');
        photoTool.preview.src = imageDataUrl; photoTool.preview.style.display = 'block';
        stopActiveCamera();
        manageProcessingIndicator(() => processPhotoWithAI(imageDataUrl));
    });
    photoTool.fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
                const imageDataUrl = event.target.result;
                photoTool.preview.src = imageDataUrl;
                photoTool.preview.style.display = 'block';
                manageProcessingIndicator(() => processPhotoWithAI(imageDataUrl));
            };
            reader.readAsDataURL(file);
        }
        e.target.value = null;
    });

    const visionTools = [
        { name: "cash", ui: ui.cashReaderTool, analyze: analyzeCurrencyWithVision },
        { name: "object", ui: ui.objectIdentifierTool, analyze: analyzeObjectWithVision },
        { name: "doc", ui: ui.documentScannerTool, analyze: analyzeDocumentWithVision }
    ];

    visionTools.forEach(toolInfo => {
        const tool = toolInfo.ui;
        if (!tool) return;
        tool.startCameraButton?.addEventListener('click', () => { if (activeCameraStream) { stopActiveCamera(); } else { startCameraFor(tool); } });
        tool.captureButton?.addEventListener('click', () => {
            const video = tool.cameraFeed; const canvas = tool.cameraCanvas;
            if (video.videoWidth === 0) { speakSystemMessage("Camera not ready."); return; }
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageDataUrl = canvas.toDataURL('image/jpeg');
            tool.preview.src = imageDataUrl; tool.preview.style.display = 'block';
            stopActiveCamera();
            manageProcessingIndicator(() => toolInfo.analyze(imageDataUrl));
        });
        tool.fileInput?.addEventListener('change', (e) => {
            const file = e.target.files[0]; if (!file) return; stopActiveCamera();
            const reader = new FileReader();
            reader.onload = (event) => {
                const imageDataUrl = event.target.result;
                tool.preview.src = imageDataUrl; tool.preview.style.display = 'block';
                manageProcessingIndicator(() => toolInfo.analyze(imageDataUrl));
            };
            reader.readAsDataURL(file); e.target.value = null;
        });
    });

    async function analyzeWithVision(toolUI, prompt, imageDataUrl) {
        toolUI.statusMessage.textContent = "Analyzing with vision...";
        toolUI.resultArea.textContent = "";
        speakSystemMessage("Analyzing image...");
        try {
            const reply = await queryAI(prompt, true, imageDataUrl);
            toolUI.resultArea.textContent = reply;
            toolUI.statusMessage.textContent = 'Analysis complete.';
            toolUI.readButton.disabled = false;
            if (toolUI.copyButton) toolUI.copyButton.disabled = false;
            speakSystemMessage(reply);
        } catch (e) {
            log(`Vision AI Err: ${e.message}`);
            toolUI.resultArea.textContent = ""; // Clear result area on error
            toolUI.statusMessage.textContent = e.message;
            speakSystemMessage(e.message);
        }
    }

    function analyzeCurrencyWithVision(imageDataUrl) { analyzeWithVision(ui.cashReaderTool, "Identify the currency in this image. Describe it clearly, stating the country, the denomination (e.g., 20 dollars, 500 rupees), and the main color. Be confident and concise.", imageDataUrl); }
    function analyzeObjectWithVision(imageDataUrl) { analyzeWithVision(ui.objectIdentifierTool, "What is the main object in this image? Describe it in a single, clear sentence.", imageDataUrl); }
    function analyzeDocumentWithVision(imageDataUrl) { analyzeWithVision(ui.documentScannerTool, "Scan this document image. Extract its text, then provide a short summary of its purpose (e.g., 'This is a receipt', 'This is an article'). List any key information found, such as title, dates, total amount, or names. Format the summary and key points clearly, then provide the full extracted text below.", imageDataUrl); }
    
    ui.cashReaderTool.readButton?.addEventListener('click',()=>{const t=ui.cashReaderTool.resultArea.textContent;if(t.trim())speakSystemMessage(t);});
    ui.objectIdentifierTool.readButton?.addEventListener('click',()=>{const t=ui.objectIdentifierTool.resultArea.textContent;if(t.trim())speakSystemMessage(t);});
    ui.documentScannerTool.readButton?.addEventListener('click',()=>{const t=ui.documentScannerTool.resultArea.textContent;if(t.trim())speakSystemMessage(t);});
    ui.documentScannerTool.copyButton?.addEventListener('click', ()=>{const t = ui.documentScannerTool.resultArea.textContent; if(t.trim()) navigator.clipboard.writeText(t).then(() => speakSystemMessage("Copied."))});
    
    // --- Location Hub ---
    function initializeMap() { if (leafletMap || !ui.locationTool.mapContainer) return; try { leafletMap = L.map(ui.locationTool.mapContainer).setView([20, 0], 2); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© OpenStreetMap' }).addTo(leafletMap); searchMarkers.addTo(leafletMap); } catch(e) { log(`Leaflet init failed: ${e.message}`); ui.locationTool.mapContainer.innerHTML = `<p>Could not load map.</p>`; } }
    async function findUserLocation() { const toolUI = ui.locationTool; const locationPermissionGranted = await requestPermission('location'); if (!locationPermissionGranted) { toolUI.statusMessage.textContent = 'Precise location permission is required.'; return; } speakSystemMessage("Pinpointing your location..."); toolUI.statusMessage.textContent = 'Getting your precise location...'; toolUI.resultCard.style.display = 'none'; toolUI.tellMeMoreButton.style.display = 'none'; navigator.geolocation.getCurrentPosition(async (pos) => { const { latitude: lat, longitude: lon } = pos.coords; lastKnownPosition = { coords: { latitude: lat, longitude: lon } }; if (leafletMap) { leafletMap.setView([lat, lon], 14); if (userMarker) { userMarker.setLatLng([lat, lon]); } else { userMarker = L.marker([lat, lon]).addTo(leafletMap); } userMarker.bindPopup("<b>You are here</b>").openPopup(); searchMarkers.clearLayers(); } try { const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`); const data = await response.json(); const addr = data.display_name || "Address not available."; toolUI.addressSpan.textContent = addr; toolUI.coordsSpan.textContent = `${lat.toFixed(5)}, ${lon.toFixed(5)}`; toolUI.readButton.disabled = false; toolUI.resultCard.style.display = 'block'; toolUI.tellMeMoreButton.style.display = 'block'; toolUI.statusMessage.textContent = 'Location found.'; speakSystemMessage(`Location found. Address is: ${addr}.`); } catch (e) { toolUI.addressSpan.textContent = "Address lookup failed."; toolUI.resultCard.style.display = 'block'; speakSystemMessage("Coordinates found, but address lookup failed."); } }, (err) => { let msg = "Could not get your location."; if (err.code === err.PERMISSION_DENIED) msg = "Location access was denied."; toolUI.statusMessage.textContent = msg; speakSystemMessage(msg); }, { timeout: 12000, enableHighAccuracy: true }); }
    ui.locationTool.getLocationButton.addEventListener('click', () => manageProcessingIndicator(findUserLocation));
    async function searchPlaces() { const isAroundMe = document.getElementById('aroundMeContent').classList.contains('active'); let query = isAroundMe ? document.querySelector('input[name="aroundMeCategory"]:checked')?.value.replace(/_/g, ' ') : ui.locationTool.nearbySearchInput.value.trim(); if (!query) { speakSystemMessage("Please select or enter a search term."); return; } if (isAroundMe && !lastKnownPosition) { speakSystemMessage("Current location unknown. Use 'Where Am I?' first."); return; } const resultsArea = isAroundMe ? ui.aroundMeTool.resultsArea : ui.locationTool.nearbySearchResults; const statusMessage = isAroundMe ? ui.aroundMeTool.statusMessage : ui.locationTool.nearbyStatusMessage; speakSystemMessage(`Searching for ${query}.`); statusMessage.textContent = `Searching...`; resultsArea.innerHTML = ''; if(leafletMap) searchMarkers.clearLayers(); try { let url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&addressdetails=1&limit=10`; if (isAroundMe && lastKnownPosition) { const { latitude, longitude } = lastKnownPosition.coords; url += `&viewbox=${[longitude - 0.5, latitude - 0.5, longitude + 0.5, latitude + 0.5].join(',')}&bounded=1`; } const results = await (await fetch(url, { headers: { 'Accept-Language': 'en' } })).json(); statusMessage.textContent = ""; if (results && results.length > 0) { let html = `<h4>Results for "${query}":</h4>`, speakable = `${results.length} results found. `, bounds = []; results.forEach((place, idx) => { const lat = parseFloat(place.lat), lon = parseFloat(place.lon), name = place.display_name.split(',')[0]; html += `<div class="search-result-item"><h4><a href="https://www.openstreetmap.org/?mlat=${lat}&mlon=${lon}#map=16/${lat}/${lon}" target="_blank" rel="noopener">${idx + 1}. ${name}</a></h4><p>${place.display_name.substring(name.length + 2)}</p></div>`; if (idx < 3) speakable += `${name}. `; if(leafletMap) { searchMarkers.addLayer(L.marker([lat, lon]).bindPopup(`<b>${idx + 1}. ${name}</b>`)); bounds.push([lat, lon]); } }); if (leafletMap && bounds.length > 0) leafletMap.fitBounds(bounds, { padding: [50, 50] }); resultsArea.innerHTML = html; speakSystemMessage(speakable); } else { resultsArea.innerHTML = `<p>No results found for "${query}".</p>`; speakSystemMessage(`No results found.`); } } catch (e) { log(`Nominatim Search Err: ${e.message}`); statusMessage.textContent = "Search failed."; speakSystemMessage("Search failed."); } }
    ui.locationTool.executeSearchButton.addEventListener('click', () => manageProcessingIndicator(searchPlaces)); ui.locationTool.nearbySearchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); manageProcessingIndicator(searchPlaces); } }); ui.aroundMeTool.findButton.addEventListener('click', () => manageProcessingIndicator(searchPlaces));
    ui.locationTool.readButton.addEventListener('click',()=>{const s=`Address: ${ui.locationTool.addressSpan.textContent}. Coordinates: ${ui.locationTool.coordsSpan.textContent}.`;if(s.trim())speakSystemMessage(s);});
    ui.locationTool.tellMeMoreButton.addEventListener('click', () => { manageProcessingIndicator(async () => { if(!lastKnownPosition) { speakSystemMessage("No location data available."); return; } const {latitude, longitude} = lastKnownPosition.coords; speakSystemMessage("Asking for more details about this area..."); try { const prompt = `Tell me about the area at latitude ${latitude.toFixed(4)} and longitude ${longitude.toFixed(4)}. What is this place known for? Is it commercial, residential, or rural? Mention any famous landmarks nearby.`; const description = await queryAI(prompt); alert(description); speakSystemMessage(description); } catch (e) { log(`Location AI info error: ${e.message}`); speakSystemMessage(e.message); } }); });
    ui.locationTool.setReminderButton.addEventListener('click',()=>{ if(locationReminderIntervalId){ cancelLocationReminder(); } else { ui.locationTool.reminderModalOverlay.classList.add('visible'); } }); ui.locationTool.closeReminderModal.addEventListener('click',()=>ui.locationTool.reminderModalOverlay.classList.remove('visible')); ui.locationTool.reminderOptions.addEventListener('click',(e)=>{ if(e.target.tagName==='BUTTON'&&e.target.dataset.interval){ setLocationReminder(parseInt(e.target.dataset.interval)); } });
    function setLocationReminder(minutes){ if(locationReminderIntervalId) clearInterval(locationReminderIntervalId); locationReminderIntervalId=setInterval(()=>{ speakSystemMessage(`Reminder: ${minutes} minutes have passed.`); },minutes*60*1000); ui.locationTool.activeReminderStatus.textContent=`Reminder: Every ${minutes} mins.`; ui.locationTool.setReminderButton.querySelector('span').textContent = 'Cancel Reminder'; speakSystemMessage(`Reminder set for every ${minutes} minutes.`); ui.locationTool.reminderModalOverlay.classList.remove('visible'); }
    function cancelLocationReminder(){ if(locationReminderIntervalId){ clearInterval(locationReminderIntervalId); locationReminderIntervalId=null; ui.locationTool.activeReminderStatus.textContent=""; ui.locationTool.setReminderButton.querySelector('span').textContent = 'Set Reminder'; speakSystemMessage("Reminder cancelled."); } }
    
    async function fetchNews() { const toolUI = ui.newsTool; const category = toolUI.categorySelect.value, country = toolUI.countrySelect.value; currentNewsArticles = []; toolUI.readButton.disabled = true; speakSystemMessage(`Fetching ${NEWS_CATEGORIES[category]} news for ${NEWS_COUNTRIES[country]}.`); toolUI.statusMessage.textContent = 'Fetching...'; toolUI.resultArea.innerHTML = ''; try { const prompt = `Act as a news reporter. Provide the top 5 most current and important news headlines for the '${NEWS_CATEGORIES[category]}' category in '${NEWS_COUNTRIES[country]}'. For each headline, provide a concise title and a 1-2 sentence summary. Do not use markdown. Format each article separated by '###'. Example: Title: [title]\nSummary: [summary]\n###`; const reply = await queryAI(prompt); const articles = reply.split('###').filter(a => a.trim()); if (articles.length === 0) throw new Error("No news in correct format."); let html = ""; articles.forEach(articleText => { const titleMatch = articleText.match(/Title: (.*?)\n/), summaryMatch = articleText.match(/Summary: (.*)/s); if (titleMatch && summaryMatch) { const title = titleMatch[1].trim(), summary = summaryMatch[1].trim(); currentNewsArticles.push({title, content: summary}); html += `<div class="news-item"><h3>${title}</h3><p>${summary}</p></div>`; } }); toolUI.resultArea.innerHTML = html; toolUI.statusMessage.textContent = `${currentNewsArticles.length} articles loaded.`; if (currentNewsArticles.length > 0) { toolUI.readButton.disabled = false; speakSystemMessage(`Found ${currentNewsArticles.length} articles.`); } else { speakSystemMessage(`No news found.`); } } catch (e) { log(`News Fetch Err: ${e.message}.`); toolUI.statusMessage.textContent = e.message; speakSystemMessage(e.message); } }
    ui.newsTool.getNewsButton.addEventListener('click', () => manageProcessingIndicator(fetchNews));
    ui.newsTool.readButton.addEventListener('click',()=>{if(currentNewsArticles.length>0){let s=`Top headlines: `;currentNewsArticles.forEach((a,i)=>{s+=`Headline ${i+1}: ${a.title}. ${a.content}. `;});speakSystemMessage(s);}else{speakSystemMessage("No news to read.");}});
    
    ui.textToPdfTool.generateButton.addEventListener('click',()=>{const t=ui.textToPdfTool.textInput.value; if(!t.trim()){speakSystemMessage("Enter text for PDF.");return;}if(typeof jspdf?.jsPDF==='undefined'){speakSystemMessage("PDF tool not ready.");return;}speakSystemMessage("Generating PDF.");try{const{jsPDF}=jspdf,doc=new jsPDF();doc.text(doc.splitTextToSize(t,180),10,10);doc.save('TEYE_document.pdf');}catch(e){log(`Text to PDF Err: ${e.message}`);speakSystemMessage("PDF generation failed.");}});
    
    ui.htmlToPdfTool.convertButton.addEventListener('click', () => { const htmlContent = ui.htmlToPdfTool.input.value; if (!htmlContent.trim()) { speakSystemMessage("Please enter HTML."); return; } if (typeof jspdf?.jsPDF === 'undefined' || typeof html2canvas === 'undefined') { speakSystemMessage("PDF converter is not ready."); return; } manageProcessingIndicator(async () => { speakSystemMessage("Converting HTML to PDF..."); const { jsPDF } = jspdf; const doc = new jsPDF('p', 'pt', 'a4'); const temp = document.createElement('div'); temp.style.cssText = 'position:absolute;left:-9999px;width:700px;padding:20px;background:white;color:black;'; temp.innerHTML = htmlContent; document.body.appendChild(temp); try { const canvas = await html2canvas(temp, { scale: 2, useCORS: true, logging: false }); const imgData = canvas.toDataURL('image/png'), pdfW = doc.internal.pageSize.getWidth(), pdfH = doc.internal.pageSize.getHeight(), imgH = canvas.height * pdfW / canvas.width; let hLeft = imgH, pos = 0; doc.addImage(imgData, 'PNG', 0, pos, pdfW, imgH); hLeft -= pdfH; while(hLeft > 0) { pos = hLeft - imgH; doc.addPage(); doc.addImage(imgData, 'PNG', 0, pos, pdfW, imgH); hLeft -= pdfH; } doc.save("TEYE_from_html.pdf"); speakSystemMessage("PDF generated."); } catch (err) { log(`html2canvas Err: ${err}`); speakSystemMessage("Could not convert HTML."); } finally { if(document.body.contains(temp)) document.body.removeChild(temp); } }); });

    ui.qrCodeGeneratorTool.generateButton.addEventListener('click', () => { manageProcessingIndicator(async () => { const data = ui.qrCodeGeneratorTool.dataInput.value.trim(), size = ui.qrCodeGeneratorTool.sizeInput.value || 200; if (!data) { speakSystemMessage("Please enter data for QR code."); return; } speakSystemMessage("Generating QR code."); const apiUrl = `https://api.qrserver.com/v1/create-qr-code/?data=${encodeURIComponent(data)}&size=${size}x${size}&format=png`; try { const blob = await (await fetch(apiUrl)).blob(), imgUrl = URL.createObjectURL(blob); ui.qrCodeGeneratorTool.resultArea.innerHTML = `<img src="${imgUrl}" alt="QR Code">`; ui.qrCodeGeneratorTool.downloadButton.style.display = 'inline-flex'; ui.qrCodeGeneratorTool.downloadButton.onclick = () => { const a = document.createElement('a'); a.href = imgUrl; a.download = `qrcode.png`; a.click(); a.remove(); }; } catch (e) { log(`QR Code Err: ${e.message}`); speakSystemMessage("QR Code generation failed."); } }); });
    
    function manualSlaCalculation(uptime) { const down = 100 - uptime, secs = 31557600 * (down/100); return { yearly: formatDowntime(secs), monthly: formatDowntime(secs/12), weekly: formatDowntime(secs/52.1775), daily: formatDowntime(secs/365.25) }; } function formatDowntime(s) { if (s <= 0) return '0s'; if (s < 60) return `${s.toFixed(2)}s`; let d=Math.floor(s/86400);s%=86400;let h=Math.floor(s/3600);s%=3600;let m=Math.floor(s/60);s=Math.floor(s%60); return [d?`${d}d`:'', h?`${h}h`:'', m?`${m}m`:'', s?`${s}s`:''].filter(Boolean).join(' ') || '0s'; }
    ui.slaCalculatorTool.calculateButton.addEventListener('click', () => { const uptime = parseFloat(ui.slaCalculatorTool.uptimePercentInput.value); if (isNaN(uptime) || uptime < 0 || uptime > 100) { speakSystemMessage("Please enter a valid uptime percentage."); return; } const results = manualSlaCalculation(uptime); ui.slaCalculatorTool.resultArea.innerHTML = `<h4>Downtime for ${uptime}% Uptime:</h4><p><strong>Yearly:</strong> ${results.yearly}</p><p><strong>Monthly:</strong> ${results.monthly}</p><p><strong>Weekly:</strong> ${results.weekly}</p><p><strong>Daily:</strong> ${results.daily}</p>`; speakSystemMessage(`For ${uptime}% uptime, yearly downtime is ${results.yearly}.`); });

    ui.ipInfoTool.fetchButton.addEventListener('click', () => { manageProcessingIndicator(async () => { const ipAddress = ui.ipInfoTool.ipAddressInput.value.trim(); speakSystemMessage("Fetching IP information..."); try { const data = await (await fetch(`https://ipinfo.io/${ipAddress}?token=${API_KEYS.IPINFO}`)).json(); if (data.error) throw new Error(data.error.title); lastIpInfo = data; const loc = [data.city, data.region, data.country].filter(Boolean).join(', '); ui.ipInfoTool.resultArea.innerHTML = `<h4>Details for ${data.ip}</h4><p><strong>Location:</strong> ${loc||'N/A'}</p><p><strong>ISP:</strong> ${data.org||'N/A'}</p>`; ui.ipInfoTool.tellMeMoreButton.style.display = 'block'; speakSystemMessage(`IP details loaded for ${data.ip}.`); } catch (e) { log(`IP Info Err: ${e.message}`); speakSystemMessage(`Could not fetch IP information.`); lastIpInfo = null; ui.ipInfoTool.tellMeMoreButton.style.display = 'none'; ui.ipInfoTool.resultArea.innerHTML = `<p>Error.</p>`; } }); });
    ui.ipInfoTool.tellMeMoreButton.addEventListener('click', () => { manageProcessingIndicator(async () => { if(!lastIpInfo) return; speakSystemMessage("Asking for more details about this IP..."); try { const prompt = `Explain this IP info in simple terms: ${JSON.stringify(lastIpInfo)}.`; const description = await queryAI(prompt); alert(description); speakSystemMessage(description); } catch (e) { speakSystemMessage(e.message); } }); });
    
    async function fetchJoke() {
        const tool = ui.jokeTool;
        speakSystemMessage("Finding a new joke!");
        tool.fetchJokeButton.disabled = true;
        try {
            const exclusionList = recentJokes.length > 0 ? `It MUST NOT be any of the following jokes I've already heard: [${recentJokes.join('; ')}]` : '';
            const prompt = `Tell me a single, short, family-friendly joke. ${exclusionList}`;
            currentJokeText = await queryAI(prompt);
            tool.jokeResultArea.innerHTML = `<p>${currentJokeText.replace(/\n/g, '<br>')}</p>`;
            tool.readJokeButton.disabled = false;
            tool.libraryAddButton.disabled = false;
            
            recentJokes.push(currentJokeText);
            if (recentJokes.length > 10) recentJokes.shift();
            
            speakSystemMessage(currentJokeText);
        } catch(e) {
            log(`Joke Fetch Err: ${e.message}`);
            tool.jokeResultArea.textContent = "Try again!";
            speakSystemMessage(e.message);
        } finally {
            tool.fetchJokeButton.disabled = false;
        }
    }
    ui.jokeTool.fetchJokeButton.addEventListener('click', () => manageProcessingIndicator(fetchJoke));
    ui.jokeTool.readJokeButton.addEventListener('click', () => { if (currentJokeText) speakSystemMessage(currentJokeText); });
    
    ui.codeTesterTool.renderButton.addEventListener('click', () => { ui.codeTesterTool.iframe.srcdoc = ui.codeTesterTool.codeInput.value; speakSystemMessage("HTML rendered."); });
    ui.codeTesterTool.downloadButton.addEventListener('click', () => { const b = new Blob([ui.codeTesterTool.codeInput.value], { type: 'text/html;charset=utf-8' }); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'TEYE_code.html'; a.click(); a.remove(); URL.revokeObjectURL(a.href); });
    
    ui.calculatorTool.buttons.forEach(button => { let currentInput = ""; button.addEventListener('click', (e) => { const value = e.target.dataset.value, display = ui.calculatorTool.display; if (value === 'AC') { currentInput = ""; display.value = "0"; } else if (value === 'DEL') { currentInput = currentInput.slice(0, -1); display.value = currentInput || "0"; } else if (value === '=') { if (!currentInput) return; try { let result = new Function('return ' + currentInput.replace(/×/g, '*').replace(/÷/g, '/'))(); display.value = result; currentInput = String(result); speakSystemMessage(`Result is ${result}`); } catch (err) { display.value = "Error"; currentInput = ""; speakSystemMessage("Error."); } } else { currentInput += value; display.value = currentInput; } }); });

    async function fetchQuote() {
        const tool = ui.quotationsTool;
        const category = tool.quoteCategoryInput.value.trim();
        speakSystemMessage(category ? `Fetching a quote about ${category}` : "Fetching a new quote.");
        tool.fetchButton.disabled = true;
        try {
            const exclusionList = recentQuotes.length > 0 ? `It must be a new quote that is NOT in this list of previous quotes: [${recentQuotes.map(q => `"${q.text}"`).join('; ')}]` : '';
            const prompt = `Share one profound and unique quote about "${category || 'life'}". ${exclusionList}. Format your response as ONLY: "The quote text" — Author`;
            const reply = await queryAI(prompt);
            const parts = reply.split('—');
            const quoteText = (parts.length > 1 ? parts.slice(0, -1).join('—') : reply).trim().replace(/^"|"$/g, '');
            const authorText = parts.length > 1 ? parts[parts.length - 1].trim() : "Unknown";
            displayQuote(quoteText, authorText);
            speakSystemMessage(`Quote by ${authorText}: ${quoteText}`);
        } catch(e) {
            log(`Quote Fetch Err: ${e.message}`);
            displayQuote("The journey of a thousand miles begins with a single step.", "Lao Tzu");
            speakSystemMessage(e.message);
        } finally {
            tool.fetchButton.disabled = false;
        }
    }
    
    function displayQuote(text, author) {
        const tool = ui.quotationsTool;
        currentQuote = {text, author};
        tool.quoteTextElement.textContent = `“${text}”`;
        tool.quoteAuthorElement.textContent = `— ${author}`;
        tool.readButton.disabled = false;
        tool.copyButton.disabled = false;
        if(navigator.share) tool.shareButton.disabled = false;
        tool.libraryAddButton.disabled = false;

        recentQuotes.push(currentQuote);
        if (recentQuotes.length > 10) recentQuotes.shift();
    }
    ui.quotationsTool.fetchButton.addEventListener('click', () => manageProcessingIndicator(fetchQuote));
    ui.quotationsTool.readButton.addEventListener('click', () => { if(currentQuote.text) speakSystemMessage(`"${currentQuote.text}" by ${currentQuote.author}`); });
    ui.quotationsTool.copyButton.addEventListener('click', () => { if(currentQuote.text) { navigator.clipboard.writeText(`“${currentQuote.text}” — ${currentQuote.author}`).then(()=>speakSystemMessage("Copied.")); } });
    if(navigator.share) { ui.quotationsTool.shareButton.addEventListener('click', () => { if(currentQuote.text) { navigator.share({title: `Quote by ${currentQuote.author}`, text: `“${currentQuote.text}” — ${currentQuote.author}` }); }}); } else { ui.quotationsTool.shareButton.style.display = 'none'; }

    function getLibrary() { try { return JSON.parse(localStorage.getItem('TEYE_MyLibrary')) || []; } catch (e) { return []; } }
    function saveLibrary(library) { localStorage.setItem('TEYE_MyLibrary', JSON.stringify(library)); }
    function addToLibrary(item) { if (!item || !item.type || !item.content) return; const library = getLibrary(); item.id = Date.now(); library.unshift(item); saveLibrary(library); speakSystemMessage(`${item.type} saved to Library.`); }
    function deleteFromLibrary(id) { saveLibrary(getLibrary().filter(item => item.id !== id)); renderLibrary(); speakSystemMessage("Item removed."); }
    function renderLibrary() { const library = getLibrary(), container = ui.moreSection.libraryDisplayArea; container.innerHTML = library.length === 0 ? `<p>Your library is empty.</p>` : ''; library.forEach(item => { const div = document.createElement('div'); div.className = 'library-item'; let contentText = item.content.replace(/</g, "&lt;"); div.innerHTML = `<h4>${item.type} ${item.author?`by ${item.author}`:''} <small>(${new Date(item.id).toLocaleDateString()})</small></h4><p class="library-item-content">${contentText}</p><div class="library-item-actions"><button class="action-button read-btn"><i class="fas fa-volume-up"></i></button><button class="action-button copy-btn"><i class="fas fa-copy"></i></button><button class="action-button del-btn" style="background-color:#d32f2f;color:#fff;"><i class="fas fa-trash"></i></button></div>`; div.querySelector('.read-btn').onclick = () => speakSystemMessage(item.content); div.querySelector('.copy-btn').onclick = () => { navigator.clipboard.writeText(item.content); speakSystemMessage("Copied."); }; div.querySelector('.del-btn').onclick = () => deleteFromLibrary(item.id); container.appendChild(div); }); }
    
    ui.moreSection.clearLibraryButton.addEventListener('click', () => { if(getLibrary().length > 0 && confirm("Are you sure you want to delete the entire library?")) { saveLibrary([]); renderLibrary(); speakSystemMessage("Library cleared."); } });
    ui.textToImageTool.libraryAddButton.addEventListener('click', () => { const prompt = ui.textToImageTool.promptInput.value.trim(); if(prompt) addToLibrary({type: 'Image Prompt', content: prompt}); });
    ui.quotationsTool.libraryAddButton.addEventListener('click', () => { if(currentQuote.text) addToLibrary({type: 'Quote', content: `"${currentQuote.text}"`, author: currentQuote.author}); });
    ui.jokeTool.libraryAddButton.addEventListener('click', () => { if(currentJokeText) addToLibrary({type: 'Joke', content: currentJokeText}); });
    ui.moreSection.resetPermissionsButton.addEventListener('click', () => { alert("Permissions are now managed directly by your browser. To reset them, go to your browser's site settings for this page and change the permissions from there."); speakSystemMessage("To reset permissions, please use your browser's site settings menu."); });

    function handleFirstInteraction(){ if(!userInteractedOnce){ userInteractedOnce=true; log("Audio unlocked by user."); if (ui.soundPromptOverlay) ui.soundPromptOverlay.style.cssText += 'visibility:hidden;opacity:0;display:none;'; if(ui.welcomeSoundAudioPlayer) ui.welcomeSoundAudioPlayer.play().catch(e=>{}); } }
    ui.soundPromptOkButton.addEventListener('click', () => { handleFirstInteraction(); playProcessingSound(); });

    function initializeAppAfterLoginAndPermissions(){
        log(`App Main Init (v${appInfo.version})...`);
        applyTheme(localStorage.getItem('appTheme')||'dark');
        setTimeout(populateVoiceList, 100);
        if(ui.translatorTool.fromLangSelect) populateLanguageDropdowns();
        if(ui.newsTool.countrySelect) { Object.keys(NEWS_COUNTRIES).forEach(key => ui.newsTool.countrySelect.add(new Option(NEWS_COUNTRIES[key], key))); ui.newsTool.countrySelect.value = 'us'; }
        
        initializeMap();
        activateTab('homeContent'); 
        if(localStorage.getItem('initialVocarooPlayedOnceGlobal')!=='true') ui.initialPlayOverlay.classList.add('visible');
        else ui.initialPlayOverlay.style.display = 'none';
        if (ui.moreSection.userGuideTextList) { ui.moreSection.userGuideTextList.innerHTML = Object.values(appInfo.guides).map(guide => `<li>${guide}</li>`).join(''); }
    }

    ui.playInitialInstructionsButton.addEventListener('click',()=>{handleFirstInteraction();tryPlayVocaroo(true);localStorage.setItem('initialVocarooPlayedOnceGlobal','true');if(ui.initialPlayOverlay)ui.initialPlayOverlay.classList.remove('visible');});
    
    // Transit Hub Functions
    async function runTransitTask(tool, task) { const statusEl = ui.transitHubTool.busDataStatus || ui.transitHubTool.konkanTrainStatus || ui.transitHubTool.sbbDataStatus || ui.transitHubTool.iamSmartStatus; statusEl.textContent = 'Fetching...'; try { await task(); } catch (e) { log(`Transit err: ${e}`); statusEl.textContent = 'Error fetching data.'; } }
    ui.transitHubTool.fetchBusDataButton.addEventListener('click', () => manageProcessingIndicator(async () => { const { busCompanySelect, busRouteInput, busStopIdInput, busDataResultArea, busDataStatus } = ui.transitHubTool; const company = busCompanySelect.value, route = busRouteInput.value.trim().toUpperCase(), stopId = busStopIdInput.value.trim().toUpperCase(); if (!route) {busDataStatus.textContent = ''; return;} let apiUrl = `https://data.etabus.gov.hk/v1/transport/${company}/` + (stopId ? `stop-eta/${stopId}` : `route-eta/${route}/all`); try { const data = await (await fetch(apiUrl)).json(); if (data?.data?.length > 0) { busDataResultArea.innerHTML = `<h4>Bus ETAs for ${company.toUpperCase()} ${route}:</h4>` + data.data.slice(0, 5).map(eta => `<div class="transit-result-item"><p><strong>To ${eta.dest_en}:</strong> ETA ${new Date(eta.eta).toLocaleTimeString()}</p></div>`).join(''); busDataStatus.textContent = `${data.data.length} results.`; } else {busDataResultArea.innerHTML = ''; busDataStatus.textContent = 'No data found.';} } catch(e) { log(`Bus Data Err: ${e}`); busDataStatus.textContent = 'Failed to fetch bus data.';} }));
    ui.transitHubTool.fetchKonkanTrainButton.addEventListener('click', () => manageProcessingIndicator(async () => { const { konkanTrainNoInput, konkanTrainResultArea, konkanTrainStatus } = ui.transitHubTool; const trainNo = konkanTrainNoInput.value.trim(); if (!trainNo) {konkanTrainStatus.textContent = ''; return;} try { const txt = await (await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(`https://konkanrailway.com/TrainSchedule/Components/FetchRunningInfoPlain?trainno=${trainNo}`)}`)).text(); if (txt) { konkanTrainResultArea.innerHTML = `<div style="white-space: pre-wrap;">${txt.replace(/<[^>]*>?/gm, '').trim()}</div>`; konkanTrainStatus.textContent = 'Position updated.'; } else { konkanTrainResultArea.innerHTML = ''; konkanTrainStatus.textContent = 'No data found.';} } catch(e) { log(`Konkan Data Err: ${e}`); konkanTrainStatus.textContent = 'Failed to fetch train data.'; } }));
    ui.transitHubTool.fetchSbbDataButton.addEventListener('click', () => manageProcessingIndicator(async () => { const { sbbStationInput, sbbDataResultArea, sbbDataStatus } = ui.transitHubTool; const station = sbbStationInput.value.trim(); if (!station) {sbbDataStatus.textContent = ''; return;} try { const data = await (await fetch(`https://transport.opendata.ch/v1/stationboard?station=${station}&limit=10`)).json(); if (data?.stationboard?.length > 0) { sbbDataResultArea.innerHTML = `<h4>Departures from ${data.station.name}:</h4>` + data.stationboard.map(item => `<div class="transit-result-item"><p><strong>${new Date(item.stop.departure).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} to ${item.to}</strong> (Plat. ${item.stop.platform || 'N/A'})</p></div>`).join(''); sbbDataStatus.textContent = `Found ${data.stationboard.length} departures.`; } else { sbbDataResultArea.innerHTML = ''; sbbDataStatus.textContent = 'No data found.'; } } catch(e) { log(`SBB Data Err: ${e}`); sbbDataStatus.textContent = 'Failed to fetch SBB data.';} }));
    ui.transitHubTool.fetchIamSmartButton.addEventListener('click', () => manageProcessingIndicator(async () => { const { iamSmartResultArea, iamSmartStatus } = ui.transitHubTool; try { const data = await (await fetch(`https://api.allorigins.win/raw?url=https%3A%2F%2Fstatic.iamsmart.gov.hk%2Fregsvc%2Frs-locat-prod.json`)).json(); if (data?.locations_en?.length > 0) { iamSmartResultArea.innerHTML = `<h4>iAM Smart Locations:</h4>` + data.locations_en.slice(0, 10).map(loc => `<div class="iam-smart-result-item"><p><strong>${loc.name}</strong> (${loc.dist})</p></div>`).join(''); iamSmartStatus.textContent = `Found ${data.locations_en.length} locations.`; } else { iamSmartResultArea.innerHTML = ''; iamSmartStatus.textContent = 'No data found.';} } catch(e) { log(`iAM Smart Err: ${e}`); iamSmartStatus.textContent = 'Failed to fetch location data.'; } }));
    
}); // End DOMContentLoaded</script></body></html>